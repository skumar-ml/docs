---
title: "Portal Upsell"
---

## Non-Technical

TODO: What users get to see & their checkout flow

## Overview

<Danger>
  KS: Shubham, I tried adding a screenshot of the section here, but the image was appearing too large, so I didn’t add it. Even after resizing, it was still showing big. I’ll check it again today.

  SK: You can use the "Column" layout to display.
</Danger>

- Shown in the portal to promote **early registration** for an upcoming session.
- Displays:
  - Session name (e.g., _Fall 2026_)
  - Discounted price with original price crossed out
  - Key benefits: early-bird pricing, class priority, price lock
- The **Buy Now** button is initially disabled.
- When the user **selects the semester by clicking the checkbox**, the **Buy Now** button becomes enabled.
- Clicking the enabled **Buy Now** button opens a popup to proceed with the purchase flow.

## Buy Now Modal

![Image](/images/image-58.png)

- Opens when **Buy Now** is clicked.
- User selects the student and reviews the total amount.
- **Pay Now** confirms the purchase.

## Pay Now (Stripe Payment)

- Clicking **Pay Now** redirects the user to **Stripe’s secure payment page**.
- Payment is completed on Stripe.
- After successful payment, enrollment is confirmed.

## Admins (Retool)

TODO: How can admin manage this on Retool.

## Technical

### Overview

Portal upsells (supplementary programs) are driven by `portal_upsell_program.js` and GET `getUpsellProgramV2?type=portal`. The page that hosts the supplementary programs section must instantiate `DisplaySuppProgram` with a `memberData` object that includes:

- `baseUrl` — API base URL
- `memberId` — current member ID
- `site_url` — site base URL (e.g. for success/cancel URLs)

The class fetches upsell programs, renders them as selectable cards, and when the user clicks Pay Now it calls the checkout API and redirects to Stripe.

### API

The API used is GET`getUpsellProgramV2?type=portal`. When `type=portal` is present, the API reads `upsell_program_mapping` for the current year and session and uses `portal_program_ids` (instead of `upsell_program_ids`, which is used for checkout) to decide which programs to return.

The response is an array of objects, each with:

- `upsellPrograms` — array of programs (`label`, `portal_amount`, `portal_disc_amount`, `sessionId`, `yearId`, `upsellProgramId`, `desc`)
- `yearId`, `sessionId` (of current year/session)

### What options get shown (rendering)

`DisplaySuppProgram` hides all `.bundle-sem-rounded-red-div` elements initially, then calls `displaySupplementaryProgram()`, which fetches `getUpsellProgramV2?type=portal` and stores the result. If the response has items, it calls `createBundleProgram()`, which:

- Clears `[data-upSell='card-container']` and `[data-upSell='modal-card-container']`
- Filters to academic-only and future-session programs (if available)
- For each program, appends a card from `createBundleCard()` to the card container and a card from `createModelBundleCard()` to the modal container

<Note>
  TODO: Can you explain the "academic-only" filter. How is future programs determined? **Updated description below**
</Note>

**Academic-only:** The API returns programs for both the current session and summer (sessionId 2). The frontend keeps only items where `sessionId !== 2`, so Summer is excluded and only academic-year sessions (e.g. Fall, Winter/Spring) are used.

<Note>
  TODO: Is this accurate? I'm pretty sure we are showing summer upsells in the portal?
</Note>

**Future-session programs:** For each of those academic sessions, the code filters `upsellPrograms` to programs whose `sessionId` is **not** the current session. So only programs for a different (future) term are shown—e.g. if the current session is Fall, only Winter/Spring bundles appear; if current is Winter/Spring, only the next Fall appears.

For example, please take a look at the response below, sessionId: 1 (Winter/Spring). This is the current session. First, we filter the sessionId to the upsell program array object. After that, we render the upsell program data.

<Accordion title="Example API Response">
  ```
  [
      {
          "sessionId": 1,
          "upsellPrograms": [
              {
                  "amount": 1500,
                  "desc": "Fall Tuition + Early Bird (With Deposit)",
                  "disc_amount": 1720,
                  "label": "Fall",
                  "portal_amount": 1500,
                  "portal_disc_amount": 1720,
                  "sessionId": 3,
                  "upsellProgramId": 107,
                  "yearId": 2026
              },
              {
                  "amount": 1850,
                  "desc": "Last Year's Locked-In Tuition + Early Bird",
                  "disc_amount": 2050,
                  "label": "Winter/Spring",
                  "portal_amount": 1850,
                  "portal_disc_amount": 2050,
                  "sessionId": 1,
                  "upsellProgramId": 105,
                  "yearId": 2026
              }
          ],
          "yearId": 2026
      },
      {
          "desc": "Last Year's Locked-In Tuition + $50 Off | Full-Day Enrollment",
          "disc_amount": 50,
          "sessionId": 2,
          "upsellPrograms": [
              {
                  "amount": 1500,
                  "desc": "Fall Tuition + Early Bird (With Deposit)",
                  "disc_amount": 1720,
                  "label": "Fall",
                  "portal_amount": 1500,
                  "portal_disc_amount": 1720,
                  "sessionId": 3,
                  "upsellProgramId": 107,
                  "yearId": 2026
              }
          ],
          "yearId": 2026
      }
  ]
  ```
</Accordion>

Each card shows `label`, `year`, **portal_amount** (discount price), **portal_disc_amount** (original price), and `description`. The user selects programs via checkboxes.

- **Buy now modal total price:** The total of all selected programs (`portal_amount`) is calculated and shown wherever `data-cart-total="cart-total-price"` (dom element) appears — both in the sidebar and in the modal.
- **Learn more modal total discount:** `displayTotalDiscount()` adds up all upsell product discounts (`portal_disc_amount − portal_amount`) for the selected bundle and shows this value in every element with `data-addon="discount"`.
- **Add to cart:** **disableEnableBuyNowButton()** enables or disables the **.add-to-cart(Modal)** and **.bundle-add-to-cart(sidebar)** buttons: they are disabled when no program is selected and enabled when at least one is selected. Those buttons open the checkout modal; the user then clicks **Pay Now** to start payment.

<Note>
  TODO: The last three sentences are confusing..

  1. I think some screenshots of the above will be helpful. They can be in accordions
</Note>

### Checkout flow

The checkout flow is triggered when the user clicks the **Pay Now** button (`#pay-supp-program`). `handlePaymentEvents()` ensures a student is selected from the buy-now modal dropdown (the value is used as **paymentId**, the existing payment record the bundle will be attached to). It then calls `initSupplementaryPayment(paymentId, upsellProgramIds, programName, amount)`.

<Note>
  In general, using something like `#portal-students` is not helpful. You need to describe what that is. Otherwise, I need to look at the website or code to determine what that is, which defeats the purpose of the docs.... **Updated the descriptions**
</Note>

That method:

1. Opens the Bergen credits modal via **Utils.waitForCreditApplicationChoice(memberId)** and waits for the user to choose apply or no (**applyCredit**).
2. Sends a **POST** request to **checkoutUrlForUpsellProgram**
3. Receives **cardUrl** (and optionally **achUrl**) from the API; then redirects to the Stripe page

<Note>
  TODO: Specifying all the input params for an API is usually not that useful. That's what we have Python docstrings for
</Note>

After payment, the webhook inserts the bundle placeholder as described in [Semester/Summer upsells](#).