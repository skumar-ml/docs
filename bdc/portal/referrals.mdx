---
title: "Referrals"
---

## Non-Technical

TODO: What users get to see & how they can use Referrals. What happens to users that get referred (explain pop-up that they see via referral link..)

### Overview

The [Referral](https://www.bergendebate.com/portal/referral) page allows users to invite friends and track their referral rewards in a simple and transparent way.

### Refer a Friend

Users can invite friends by entering their **name and email address**.\
Each invitation contains a **unique referral link or code** that friends can use during signup to ensure rewards are applied correctly.

### Progress Tracker

A visual progress tracker shows how many people the user has successfully referred and the **rewards unlocked at each milestone**.

![Image](/images/image-27.png)

As referrals increase, users can clearly see:

- Referral count achieved
- Reward credits earned
- Upcoming reward milestones

This helps users stay motivated and understand how close they are to the next reward.

### My Referrals

The **My Referrals** section displays a list of all invited friends along with:

- Friend’s name, Current referral status (Pending, Signed Up, Enrolled), Date referred, Enrollment status

Users can easily track which referrals are completed and which are still pending.

### Referral FAQ

A FAQ section answers common questions such as:

- What the referral program is
- Who can be referred
- What rewards both the user and their friend receive

This section helps users quickly understand the referral process without needing external support.

## Admins (Retool)

This [referral](https://bergendebate.retool.com/apps/bfafe442-3222-11f0-aebe-07c9e7fd34a5/2025%20Phase%20B/Referrals/referrals) page is used to manage and monitor referral activity.

### Top Filters & Actions

- At the top, admins can select a referrer, view the linked coupon code, choose a referred user, or click **Add Referrals** to manually add a new referral via a popup.

  **Add Referral Popup**
- Fill in referrer details (family/referrer, parent name, parent email).\
  All required fields are validated, and on **Save**, the referral is instantly added to the list.

  ![Image](/images/image-28.png)

### Referrals List (Left Panel)

Displays a **summary of all referrers** with their name, email, referral count, invites sent, and coupon code.\
Admins can scroll through the list to quickly review all referral details.

### Referral Details (Right Panel)

This section shows detailed information for the selected referrer, helping admins track and verify referrals.

- Displays the referred user’s details, referral date, purchase/enrollment date, and current status (Purchased / Not Purchased).
- **View Family** opens the [Family Snapshot ](https://bergendebate.retool.com/apps/e5b38f92-b63c-11f0-af15-3348c57919db/Student%20Consolidation/Family%20Snapshot%20-%20SC)page, where admins can see parent details, students, registrations, and overall family information.
- **Mark as Purchased / Mark as Unpurchased** opens a confirmation popup.

  ![Image](/images/image-29.png)
  - This allows admins to manually update the referral status if needed.
  - The popup asks for confirmation before applying the change to avoid mistakes.

## Technical

TODO: Explain in detail how referral system works (from Retool updates to rendering here). Include DB collections and relations. Do not explain how purchase or sign-up gets changed in status, or how new coupon code gets created (just link to respective docs). Also, explain what a referred user sees when they click a referral link.

### Overview

The referral system lets a **referrer**  share a **referral link** and **coupon code**, and submit referred people’s **name** and **email** via **POST addReferralData** (referral-promotion-service). The API creates a **referral_details** record, sends an email to the referred person with the coupon code, and schedules follow-up emails. The **referrals page** (portal) fetches **GET getReferralData/** to show the referrer’s **coupon_code**, **referrals** list (name, email, date_referred, purchased_date, referred_stage), and a form to add new referrals. **Referral link visibility** in the portal sidebar is controlled by **checkReferralsAccess** (only if the member has at least one **currentSession**). When a **referred user** lands on the site via the referral link (**?code=...&id=...**), **referrals_modal.js** shows a **pop-up** with the discount code, referrer name, and a form to claim the discount (name/email → **addReferralData**). How **referred_stage** is set to **Signed_Up** or **Purchased**, and how **coupon_details** are created, is not covered here; see the [checkout](/bdc/checkout-systems) and [post-payment](/bdc/checkout-systems/semester/web-checkout/technical/post-payment) docs.

### API and data source (referrer)

- **GET getReferralData/** (referral-promotion-service, **getReferralData.py**).
  - Look up **members** by **memberId**. If member has no **familyId** (or empty/null), return .
  - `coupon_details.find_one({ familyId: familyId })` → **coupon_code**, **couponId** (as string). If no coupon, return `{}`.
  - `referral_details.find({ couponId: couponId })`. For each referral, `members.find_one({ _id: ObjectId(referral.guestId) })` → **name**, **email**. Build list with **name**, **email**, **date_referred**, **purchased_date**, **referred_stage**.
  - Response: `{ referrals (array), coupon_code }`.
- **POST addReferralData** (referral-promotion-service, **addReferralData.py**).

  This API handles the referral flow when a parent refers someone by email.\
  It first checks whether the referred person already exists or was already referred.\
  If the person is new, it creates a guest parent account automatically.\
  The referral is then linked to the referrer’s family and an available coupon is assigned.\
  A referral email with the coupon code is sent immediately to the guest.\
  Follow-up reminder emails are scheduled automatically, and the referral is tracked in the CRM.

### DB collections and relations

| Collection           | Role                                                                                     | Key fields                                                                                                                                                                     |
| -------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **referral_details** | One document per referred person; links referrer (memberId/familyId) to guest (guestId). | **memberId**, **referral_familyId**, **guestId**, **date_referred**, **purchased_date**, **referred_stage** ("None" / "Signed_Up" / "Purchased"), **couponId**, **email_sent** |
| **coupon_details**   | One per family; stores coupon code for referral rewards.                                 | **familyId**, **coupon_code** (and others; creation/lifecycle is in checkout/post-payment docs)                                                                                |

- **Relation:** **getReferralData** joins **referral_details** to **members** (guest) by **guestId** and to **coupon_details** by **couponId** (via referrer’s **familyId**). **referred_stage** is updated to **Signed_Up** when the guest signs up (see sign-up flow) and to **Purchased** when they complete a purchase (see [post-payment](#)).

### Portal rendering (referrals page)

- **JS:** **referrals.js**, **ReferralProgram** class. The page is instantiated with **data** (memberId, baseUrl, referralCount, maxReferrals, rewards, icons).
- **Flow:** **loadReferralData()** → **GET getReferralData/**. If no **coupon_code**, alert and redirect to homepage. Set **#referralCode** to **coupon_code**; set **[data-referral='referral-link-input']** to [**https://www.bergendebate.com?code=\$&id=\$**](https://www.bergendebate.com?code=${btoa\(coupon_code\)}&id=${btoa\(memberId\)}). Copy buttons: **[data-referrals='copy']** (code), **[data-referrals='copy-link']** (link). **referrals** table: **#referralList**; each row has name (from API), status (Enrolled / Pending / Signed Up from **referred_stage**), date_referred, purchased_date. Count of “enrolled” referrals (referred_stage not None/Signed_Up) is shown in **[data-referrals='count']**. **createTracker** / **createMobileTracker** render progress (desktop/mobile) from **maxReferrals**, **rewards**, **icons**. Form **#referralForm** (name, email) → **handleFormSubmit** → **POST addReferralData** with **name**, **email**, **memberId**; on success, hide form, show success, reload **loadReferralData()**. **.no-record-div** shown when no coupon or no referrals.
- **Sidebar visibility:** **portal_new_ui.js**  calls **checkReferralsAccess(data)** after **setupTabs**. If any student has **currentSession** (length \> 0), **hasCurrentSession** is true; all **[sidebar-menu="referrals"]** elements are set to **display: flex**, else **display: none**. **hasReferralSession** (and memberId) is stored in **localStorage** for use elsewhere.

### What a referred user sees (referral link)

Checks URL parameters for referral code and ID, displays modal when user arrives via referral link or based on suppression rules, handles form submission to claim referral discount, manages modal suppression for 1 hour after dismissal, and processes referral flow.

The referral modal is triggered when a user lands on the website using a referral link\
(`https://www.bergendebate.com?code=...&id=...`, where both values are base64-encoded).

On page load, the `ReferralModal` class reads the `code` and `id` from the URL. If present, it decodes them, stores referral details in `localStorage`, updates the discount code on the page, and fetches the referrer’s name to display in the modal. If the user has not already submitted their name and email, the referral modal is shown.

When the user submits the form, the details are sent to the `addReferralData` API. On success, the referral is saved, a confirmation message is shown, and the modal closes automatically. If the referral already exists or fails, an error message is displayed.

If the modal is dismissed (close button, background click, or “No thanks”), it is suppressed for 1 hour using `localStorage`. During this time, the modal will not reappear unless the user visits again using a referral link.

If the user returns without referral parameters but has incomplete referral data saved locally, the modal may still appear to complete the process. Otherwise, no modal is shown.