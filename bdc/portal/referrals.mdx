---
title: "Referrals"
---

## Non-Technical

### Overview

The [Referral](https://www.bergendebate.com/portal/referral) page allows users to invite friends and track their referral rewards in a simple and transparent way.

**Refer a Friend:** Users can invite friends by entering their **name and email address**. Each invitation contains a **unique referral link or a coupon code** that friends can use during signup to ensure rewards are applied correctly.

<Note>
  TODO: I think we need to explain the invitation flow a little better for non-technicals -- what happens (across the tech stack) when user is invited... What gets sent in email? What happens if a new user reaches website via link...
</Note>

**Progress Tracker:** A visual progress tracker shows how many people the user has successfully referred and the **rewards unlocked at each milestone**.

![Image](/images/image-27.png)

**My Referrals:** displays a list of all invited friends along with..

![Image](/images/image-40.png)

<Note>
  TODO:

  1. Screnshot
  2. Explain when a user gets added here (if form was submitted, but what about via invited link..., obviously, if coupon code is used at checkout)?
</Note>

## Admins (Retool)

The [referral](https://bergendebate.retool.com/apps/bfafe442-3222-11f0-aebe-07c9e7fd34a5/2025%20Phase%20B/Referrals/referrals) Retool page is used to manage and monitor referral activity. On the left, admins can view how many referrals each family has. Clicking a record shows (on the left) detailed information for the selected referrer. The admin can manually mark an invited user as purchased.

TODO: Add a screenshot of the overall page...

![Image](/images/image-41.png)

Admins can also manually add a referral using the **Add Referrals** button.

TODO: What happens if user is already purchased, does it auto-attribute?

Yes , If the user has already made a purchase, it is **automatically attributed**.

## Technical

### Overview

The referral system lets a **referrer**  share a **referral link** and **coupon code** and submit referred people’s **name** and **email** via \*\*POST \*\*`addReferralData` (referral-promotion-service). The API creates a `referral_details` record, sends an email to the referred person with the coupon code, and schedules follow-up emails. The **referrals page** (portal) fetches \*\*GET \*\*`getReferralData` to show the referrer’s `coupon_code`, `referrals` list (`name`, `email`, `date_referred`, `purchased_date`, `referred_stage`), and a form to add new referrals.

**Referral link visibility** in the portal sidebar is controlled by `checkReferralsAccess` (only if the member has at least one `currentSession`).

When a **referred user** lands on the site via the referral link (**?code=...&id=...**), `referrals_modal.js` shows a **pop-up** with the discount code, referrer name, and a form to claim the discount (name/email → `addReferralData`). How `referred_stage` is set to **Signed_Up** or **Purchased**, and how `coupon_details` are created, is not covered here; see the [checkout](/bdc/checkout-systems) and [post-payment](/bdc/checkout-systems/semester/web-checkout/technical/post-payment) docs.

### API and data source (referrer)

- **GET** `getReferralData` (referral-promotion-service)
  - Look up member's `familyId`. If member has no `familyId` (or empty/null), return .
  - Get's `coupon_code` and `couponId`. If no coupon, return `{}`.
  - Look up who this family has referred in `referral_details`. For each referral, gather `name`, `email`, `date_referred`, `purchased_date`, `referred_stage`.
  - Response: `{ referrals (array), coupon_code }`.
- **POST** `addReferralData` (referral-promotion-service)

  ### 1. What is sent to the system

  When someone refers another person, the system receives: 1) **Name** of the referred person, 2) **Email** of the referred person,  3) **Member ID** of the person who is doing the referral

  ### 2. Basic checks (before saving anything)

  The system first checks the email:
  - **If the email already belongs to a member who is part of a familyId**\
    → The referral is rejected, → Message shown: **“Member already exists”**
  - **If the email was already referred earlier**\
    → The referral is rejected, → Message shown: **“Member already referred”**

  ### 3. Finding or creating the referred person (guest)(**members**)
  - If the email already exists in the system **but is not linked to any familyId yet**\
    → That existing record is used as the **guest**
  - If the email does **not exist at all**\
    → A **new guest parent account** is created in the member collection\
    → This account is marked as coming from a **referral**\
    → The new objectId is used as the **guestId**

  ### 4. Finding the referrer’s coupon(**coupon_details**)
  - The system finds the **familyId** of the person who sent the referral
  - It then looks for a **coupon linked to that family**
  - If no coupon is found\
    → The referral is rejected, → Message shown: **“Coupon not found”**

  ### 5. Saving the referral

  After all checks are passed, the system **stores the referral**.\
  It saves who sent the referral, who was referred, which coupon is linked, and the date the referral was made.\
  The referral is marked as **not yet purchased**, and the system notes that the referral email has been sent.

<Note>
  TODO: make the `addReferralData` more technical (reference collections, fields, etc).
</Note>

### DB collections and relations

| Collection           | Role                                                                                           | Key fields                                                                                                                                                     |
| -------------------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **referral_details** | One document per referred person; links referrer (`memberId`/`familyId`) to guest (`guestId`). | `memberId`, `referral_familyId`, `guestId`, `date_referred`, `purchased_date`, `referred_stage` ("None" / "Signed_Up" / "Purchased"), `couponId`, `email_sent` |
| **coupon_details**   | One per family; stores coupon code for referral rewards.                                       | `familyId`, `coupon_code` (and others; creation/lifecycle is in checkout/post-payment docs)                                                                    |

- **Relation:** `getReferralData` joins `referral_details` to `members` (guest) by `guestId` and to `coupon_details` by `couponId` (via referrer’s `familyId`). `referred_stage` is updated to `Signed_Up` when the guest signs up (see [sign-up flow](#)) and to **Purchased** when they complete a purchase (see [post-payment](#)).

<Note>
  TODO: "see sign-up flow" missing hyperlink
</Note>

### Portal rendering (referrals page)

- **JS:** `referrals.js`, `ReferralProgram` class. The page is instantiated with `data` (`memberId`, `baseUrl`, `referralCount`, `maxReferrals`, `rewards`, `icons`).
- **Flow:**
  - **loadReferralData()** → **GET getReferralData/**. If no **coupon_code**, alert and redirect to homepage.
  - **#referralCode** is set to **coupon_code**. **[data-referral='referral-link-input']** is set to `https://www.bergendebate.com?code={coupon_code}&id={memberId}`.
  - Written JavaScript code for copying  the code and link for this element: **[data-referrals='copy']** (code), **[data-referrals='copy-link']** (link).
  - **Referrals table**: each row shows name , status (Enrolled / Pending / Signed Up from **referred_stage**), date_referred, purchased_date. Status mapping: **Purchased** → "Enrolled", **Signed_Up** → "Signed Up", **None** → "Pending" from `getReferralData` API data.
  - element\*\*[data-referrals='count']\*\*  shows the count of "enrolled" referrals (referred_stage **Purchased** ).
  - **createTracker** / **createMobileTracker** render the progress bar (desktop/mobile) from **maxReferrals**, **rewards**, **icons**.
  - Form **Referral Form** (name, email) → **handleFormSubmit** → **POST addReferralData** with **name**, **email**, **memberId**. On success: hide form, show success message, call **loadReferralData()** again.
- **Sidebar visibility:** `sidebar.js` calls **checkReferralsAccess(data)** after **setupTabs**. If any student has **currentSession** (length \> 0) all **[sidebar-menu="referrals"]** elements are set to **display: flex**, else **display: none**.

<Note>
  TODO: Above needs to be updated to be a little more readable

  TODO: Did not review below. I can tell this page is a little more unfinished -- so waiting.
</Note>

### What a referred user sees (referral link)

Checks URL parameters for referral code and ID, displays modal when user arrives via referral link or based on suppression rules, handles form submission to claim referral discount, manages modal suppression for 1 hour after dismissal, and processes referral flow.

The referral modal is triggered when a user lands on the website using a referral link\
(`https://www.bergendebate.com?code=...&id=...`, where both values are base64-encoded).

On page load, the `ReferralModal` class reads the `code` and `id` from the URL. If present, it decodes them, stores referral details in `localStorage`, updates the discount code on the page, and fetches the referrer’s name to display in the modal. If the user has not already submitted their name and email, the referral modal is shown.

When the user submits the form, the details are sent to the `addReferralData` API. On success, the referral is saved, a confirmation message is shown, and the modal closes automatically. If the referral already exists or fails, an error message is displayed.

If the modal is dismissed (close button, background click, or “No thanks”), it is suppressed for 1 hour using `localStorage`. During this time, the modal will not reappear unless the user visits again using a referral link.

If the user returns without referral parameters but has incomplete referral data saved locally, the modal may still appear to complete the process. Otherwise, no modal is shown.