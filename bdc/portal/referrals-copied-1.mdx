---
title: "Referrals"
---

## Non-Technical

### Overview

The [Referral](https://www.bergendebate.com/portal/referral) page allows users to **invite friends**, share referral links or codes, and **track referral status and rewards** in a clear and transparent way.

## Current Invitation & Referral Flow

### 1. Referrer generates a referral

- An existing user receives a **unique referral code** and a **referral link**. They can share either the link (recommended) or the code directly.

### 2. Refer a Friend Via Referral Form

- Users also directly send referrals by entering a name and email and clicking **Send** — submitted entries appear in the My Referrals table with their status and enrollment progress.

![Image](/images/image-70.png)

**My Referrals Table**

![Image](/images/image-72.png)

### 3. What happens when an invite is sent

- If the referral is sent via email, the invited user receives an invitation email with a **\$100 discount**, a **call-to-action link to explore classes and register**, and a **coupon code to apply at checkout**.
- If the referral link is shared manually, the invited user is directed to the same registration flow and can apply the coupon code at checkout, but **no system-generated email** is sent.

### 4. What happens when the invited user clicks the link

<Columns cols={2}>
  <Card title="" icon="sparkles">
    When a user clicks the referral invite link, a referral popup appears confirming the invitation and showing the discount. The user enters their name and email to claim the discount, which is automatically applied at checkout and linked to the referrer.
  </Card>
  <Card title="Referral Popup Open Via Referral Link Url" icon="sparkles">
    ![Image 60](/images/image-60.png)
  </Card>
</Columns>

<Note>
  TODO: I think we need to explain the invitation flow a little better for non-technicals -- what happens (across the tech stack) when user is invited... What gets sent in email? What happens if a new user reaches website via link...
</Note>

### 4. Progress Tracker

- A visual progress tracker shows how many people the user has successfully referred and the **rewards unlocked at each milestone**.

![Image](/images/image-27.png)

<Note>
  TODO:

  1. Screnshot
  2. Explain when a user gets added here (if form was submitted, but what about via invited link..., obviously, if coupon code is used at checkout)?

     KS: Let me add.
</Note>

## Admins (Retool)

The [referral](https://bergendebate.retool.com/apps/bfafe442-3222-11f0-aebe-07c9e7fd34a5/2025%20Phase%20B/Referrals/referrals) Retool page is used to manage and monitor referral activity. On the left, admins can view how many referrals each family has. Clicking a record shows (on the left) detailed information for the selected referrer. The admin can manually mark an invited user as purchased.

![Image](/images/image-41.png)

Admins can also manually add a referral using the **Add Referrals** button. If the added user has already made a purchase, the **Purchased** stage is **automatically attributed**.

## Technical

### Overview

The referral system lets a **referrer**  share a **referral link** and **coupon code** and submit referred people’s `name` and `email` via POST `addReferralData`. The API creates a `referral_details` record, sends an email to the referred person with the coupon code, and schedules follow-up emails.

The **referrals page** (portal) fetches GET `getReferralData` to show the referrer’s `coupon_code`, `referrals` list (`name`, `email`, `date_referred`, `purchased_date`, `referred_stage`), and a form to add new referrals.

The **Referral visibility** **in the portal sidebar** is controlled by `checkReferralsAccess` (only if the member has at least one `currentSession`).

<Warning>
  TODO: Need to update so that Referrals is visible is user has one payment (not currentSession)
</Warning>

When a **referred user** lands on the site via the referral link (**?code=...&id=...**), `referrals_modal.js` shows a **pop-up** with the discount code, referrer name, and a form to claim the discount (which adds their name/email via `addReferralData`). How `referred_stage` is set to **Signed_Up** or **Purchased**, and how `coupon_details` are created, is not covered here; see the [checkout](/bdc/checkout-systems) and [post-payment](/bdc/checkout-systems/semester/web-checkout/technical/post-payment) docs.

### API and data source (referrer)

- **GET** `getReferralData`
  - Look up member's `familyId`. If member has no `familyId` (or empty/null), return.
  - Get's `coupon_code` and `couponId`. If no coupon, return `{}`.
  - Look up who this family has referred in `referral_details`. For each referral, gather `name`, `email`, `date_referred`, `purchased_date`, `referred_stage`.
  - Response: `{ referrals (array), coupon_code }`.
- **POST** `addReferralData`
  - The system receives: 1) `Name` and `Email` of the referred person, 2) `Member ID` of the referee
  - If the referred email already belongs to a member who is part of a `familyId`\
    → The referral is rejected, → Message shown: **“Member already exists”**

  <Warning>
    TODO: Shouldn't this be a member who is part of a family that is enrolled? They could be in a `familyId` and be purchased
  </Warning>
  - If the email was already referred earlier by the same referee `memberId`\
    → The referral is rejected, → Message shown: **“Member already referred”**
  - If the email already exists in the system **but is not linked to any familyId yet**\
    → That existing record is used as the **guest**
  - If the email does **not exist at all**\
    → A **new guest parent account** is created in the member collection (with source as referral)\
    → The new objectId is used as the **guestId**
  - Then, the system finds the referee **familyId** and looks for their coupon.
  - If no coupon is found\
    → The referral is rejected, → Message shown: **“Coupon not found”**
  - After all checks are passed, the system **stores the referral**. The referral is marked as **not yet purchased**, and the system notes that the referral email has been sent.

### DB collections and relations

| Collection           | Role                                                                                           | Key fields                                                                                                                                                     |
| -------------------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **referral_details** | One document per referred person; links referrer (`memberId`/`familyId`) to guest (`guestId`). | `memberId`, `referral_familyId`, `guestId`, `date_referred`, `purchased_date`, `referred_stage` ("None" / "Signed_Up" / "Purchased"), `couponId`, `email_sent` |
| **coupon_details**   | One per family; stores coupon code for referral rewards.                                       | `familyId`, `coupon_code` (and others; creation/lifecycle is in checkout/post-payment docs)                                                                    |

- **Relation:** `getReferralData` joins `referral_details` to `members` (guest) by `guestId` and to `coupon_details` by `couponId` (via referrer’s `familyId`). `referred_stage` is updated to `Signed_Up` when the guest signs up (see [sign-up flow](#)) and to **Purchased** when they complete a purchase (see [post-payment](#)).

### Portal rendering (referrals page)

- **JS:** `referrals.js`, `ReferralProgram` class. The page is instantiated with `data` (`memberId`, `baseUrl`, `referralCount`, `maxReferrals`, `rewards`, `icons`).
- **Flow:**
  - **loadReferralData()** → **GET getReferralData/**. If no **coupon_code**, alert and redirect to homepage.
  - **#referralCode** is set to **coupon_code**. **[data-referral='referral-link-input']** is set to `https://www.bergendebate.com?code={coupon_code}&id={memberId}`.
  - Written JavaScript code for copying  the code and link for this element: **[data-referrals='copy']** (code), **[data-referrals='copy-link']** (link).
  - **Referrals table**: each row shows name , status (Enrolled / Pending / Signed Up from **referred_stage**), date_referred, purchased_date. Status mapping: **Purchased** → "Enrolled", **Signed_Up** → "Signed Up", **None** → "Pending" from `getReferralData` API data.
  - element\*\*[data-referrals='count']\*\*  shows the count of "enrolled" referrals (referred_stage **Purchased** ).
  - **createTracker** / **createMobileTracker** render the progress bar (desktop/mobile) from **maxReferrals**, **rewards**, **icons**.
  - Form **Referral Form** (name, email) → **handleFormSubmit** → **POST addReferralData** with **name**, **email**, **memberId**. On success: hide form, show success message, call **loadReferralData()** again.
- **Sidebar visibility:** `sidebar.js` calls **checkReferralsAccess(data)** after **setupTabs**. If any student has **currentSession** (length \> 0) all **[sidebar-menu="referrals"]** elements are set to **display: flex**, else **display: none**.

<Note>
  TODO: Above needs to be updated to be a little more readable

  TODO: SK to review below in detail.
</Note>

### What a referred user sees (referral link)

The referral modal is triggered **when a user lands on the website using a referral link**\
(`https://www.bergendebate.com?code=...&id=...`).

On page load, the `ReferralModal` class reads the `code` and `id` from the URL. If present, it decodes them, stores referral details in `localStorage`, updates the discount code on the page, and fetches(`getMemberDetails`) \<TODO: how\> the referrer’s name to display in the modal. If the user has not already submitted their name and email, the referral modal is shown.

When the user submits the form, the details are sent to the `addReferralData` API. On success, the referral is saved, a confirmation message is shown, and the modal closes automatically. If the referral already exists or fails, an error message is displayed.

If the modal is dismissed (close button, background click, or “No thanks”), it is suppressed for 1 hour using `localStorage`. During this time, the modal will not reappear unless the user visits again using a referral link.

If the user returns without referral parameters but has incomplete referral data saved locally, the modal may still appear to complete the process. Otherwise, no modal is shown.