---
title: "Invoices"
---

## Non-Technical

TODO: What users get to see & how they can use Invoices page.

The [Payment History](#) page allows parents to view students, track outstanding invoices, and complete pending payments.

<Note>
  TODO: KS add a screenshot of the page with outstanding invoices & completed enrollments.

  SK: Added.
</Note>

### **How to Use**

- **Select a Student**\
  At the top of the page, all linked students are displayed. Click on a student to view their payment details.
- **View Outstanding Invoices**\
  Once a student is selected, all **pending or unpaid invoices** for that student appear below.

  ![Image](/images/image-87.png)
- **Check Invoice Details**\
  Click on **Invoice Breakdown** to see a detailed view of the charges, including tuition, discounts, deposits paid, and the remaining balance.

  ![Image](/images/image-33.png)
- **Make a Payment**\
  Choose a payment method (Credit/Debit Card or Bank Transfer) next to the invoice to proceed with payment via Stripe.
- **Track Payment Status**\
  After payment, the invoice status updates automatically. Once cleared, the **Outstanding Invoices** section shows **“No Invoices.”**
- **Completed Enrollments (usable for tax purposes)**

  After successful payment (or zero-amount enrollment), the record moves to **Completed Enrollments**.

  ![Image](/images/image-86.png)

  This section provides:
  - A historical view of completed enrollments by year
  - Downloadable **PDF receipts** for each enrollment

## Admins (Retool)

TODO: How can admin manage this on Retool. This section will probably be a little long, since we have a lot of invoice functionality. Explain bucket system, and how we handle pre-reg / bundled people.

## Technical

<Note>
  TODO: Let's reorganize as follows:

  1. DB (current section is good, I think)
  2. Flows
     1. Dashboard
        1. Invoice display + paying the invoice
        2. Itemized Invoice breakdown
     1. Payment History Page
        1. Rendering
        2. Portal sidebar display
</Note>

### **Where the data lives (DB)**

**invoice_notifications** — Links a payment to an invoice. (match `paymentId`).

| Field          | Description                        |
| :------------- | :--------------------------------- |
| **paymentId**  | Payment identifier.                |
| **invoice_id** | Links to **invoice_records**.\_id. |
| **emailId**    | Email identifier.                  |
| **created_on** | When the notification was created. |

**invoice_records** — One document per invoice . Looked up by `invoice_id` in aggregation.

| Field              | Description                                                  |
| :----------------- | :----------------------------------------------------------- |
| **\_id**           | MongoDB ObjectId (= invoice_id).                             |
| **title**          | Invoice name (shown as **invoiceName** on portal).           |
| **returner**       | Whether the student is a returner (affects New Student Fee). |
| **sibling**        | Whether sibling discount applies.                            |
| **earlyBirds**     | Whether early-bird discount applies.                         |
| **currentYear**    | Year ID (used with **invoice_rates**).                       |
| **classSessionId** | Session ID (used with **invoice_rates**).                    |
| **payment_type**   | e.g. `"bucket"`.                                             |

**invoice_rates** — Pricing and discounts by year/session. Used by `calculatebucketAmount` for `breakDownList`.

| Field                     | Description                 |
| :------------------------ | :-------------------------- |
| **yearId**                | Year identifier.            |
| **classSessionId**        | Session identifier.         |
| **basePrice**             | Semester tuition.           |
| **newStudent**            | New student fee.            |
| **siblingDiscPercentage** | Sibling discount (%).       |
| **earlyBirdsDiscount**    | Early-bird discount amount. |

**invoice_payment_link** — One or more payment options per invoice (card, ACH, form, etc.). Looked up by `invoice_id` in aggregation.

| Field           | Description                   |
| :-------------- | :---------------------------- |
| **invoice_id**  | Links to **invoice_records**. |
| **paymentType** | e.g. card, us_bank_account.   |
| **amount**      | Payment amount.               |
| **title**       | Link title.                   |
| **jotFormUrl**  | URL for form-based payment.   |
| **formid**      | Form identifier.              |

**invoice_responses** — One per successful (or attempted) invoice payment. Written by Stripe webhook. Looked up by `invoice_id + paymentId` in aggregation.

| Field                                                     | Description                               |
| :-------------------------------------------------------- | :---------------------------------------- |
| **invoiceId**                                             | Invoice identifier.                       |
| **paymentId**                                             | Payment identifier.                       |
| **paymentLinkId**                                         | Payment link used.                        |
| **memberId**                                              | Member identifier.                        |
| **amount**                                                | Amount paid.                              |
| **payment_intent**                                        | Stripe payment intent.                    |
| **status**                                                | Payment status.                           |
| **credit_amount**                                         | (After completion) For itemized receipts. |
| **basePrice**, **newStudent**, **sibling**, **earlyBird** | (After completion) For itemized PDFs.     |

**stripe_checkout_customer** — Created when user starts Stripe checkout for an invoice. Looked up by `invoice_id + paymentId` in aggregation.

| Field              | Description              |
| :----------------- | :----------------------- |
| **invoiceId**      | Invoice identifier.      |
| **paymentId**      | Payment identifier.      |
| **paymentLinkId**  | Payment link identifier. |
| **memberId**       | Member identifier.       |
| **status**         | Checkout status.         |
| **payment_intent** | Stripe payment intent.   |

### Flows

#### 1. Dashboard

The main portal Dashboard uses **getPortalDetail** and shows invoices in an accordion for each student tab.

##### **1.1 Invoice display + paying the invoice**

1. **JS — init and request**
   - Portal (portal_new_ui.js) loads with **apiBaseURL** and **memberId**. Calls **getPortalDetail**.
2. **API**
   - **getPortalDetail** returns per-student data with **currentSession**, **futureSession**, and **pastSession**. Each session has an **invoiceList** (and **breakDownList** per invoice). Invoice data comes from **invoice_notifications** joined with **invoice_records**, **invoice_payment_link**, **invoice_responses**, and **stripe_checkout_customer**.
   - **Returns data (invoice-specific)**

     **Student data object** (per student):

     | Field              | Description                                                                                                 |
     | :----------------- | :---------------------------------------------------------------------------------------------------------- |
     | **currentSession** | Array of session objects for current-term enrollments (each has **invoiceList**).                           |
     | **futureSession**  | Array of session objects for future-term enrollments (each has **invoiceList**).                            |
     | **pastSession**    | Array of session objects for past/completed enrollments (used for Payment history / Completed Enrollments). |

     **Session object** (each item in currentSession / futureSession / pastSession):

     | Field           | Description                                                                  |
     | :-------------- | :--------------------------------------------------------------------------- |
     | **invoiceList** | Array of invoice objects for this payment/session (from **getInvoiceList**). |
     | **createdOn**   | Session creation date (used for sorting students and sessions).              |
     | **currentYear** | Year ID (used for Payment history rows and itemized PDF by year).            |

     **Invoice object** (each item in **invoiceList**):

     | Field              | Description                                                                                                                                                                                                                                              |
     | :----------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
     | **invoice_id**     | Invoice identifier (links to **invoice_records**.\_id).                                                                                                                                                                                                  |
     | **invoiceName**    | Display name (from **invoice_records**.title).                                                                                                                                                                                                           |
     | **is_completed**   | `true` if one **invoice_response** exists for this invoice + paymentId; else unpaid/pending.                                                                                                                                                             |
     | **breakDownList**  | Object of line-item labels to amounts (see **Itemized invoice logic**). Keys include **Semester Tuition**, **New Student Fee**, **Sibling Discount**, **Early Bird**, **Deposit**. Used for Invoice Breakdown modal and to show/hide the breakdown link. |
     | **jotFormUrlLink** | Array of payment options: **paymentLinkId**, **title**, **amount**, **paymentType** (e.g. `card`, `us_bank_account`). Used to render Pay                                                                                                                 |
     | **status**         | Invoice/payment status.                                                                                                                                                                                                                                  |
     | **paymentId**      | Payment identifier.                                                                                                                                                                                                                                      |
     | **created_on**     | When the invoice notification was created (used for sorting outstanding invoices).                                                                                                                                                                       |
3. **JS — after response**
   - Combine **current session invoices** (first current session) and **future session invoices** only.
   - Show the invoice accordion: for each invoice show name, “Invoice Breakdown” link, and Pay buttons (Bank Transfer, Credit/Debit Card) for unpaid ones. Show “Needs to be completed” or “All Paid” and “X of Y invoices complete”.
   - When the user clicks Pay (Bank Transfer, Credit/Debit Card) , call **createCheckoutUrl** and redirect to Stripe.

##### 1.2 Itemized Invoice breakdown

- **Breakdown** for each invoice is computed from **invoice_rates** (by year and session). Line items include: Semester Tuition, New Student Fee (if not returner), Sibling Discount, Early Bird discount, Deposit.
- **Breakdown modal:** When the user clicks “Invoice Breakdown”, a modal opens with the line items and remaining balance. Itemized PDFs use the same breakdown data plus **invoice_responses** after payment.

#### 2. Payment History Page

##### 2.1 Rendering

1. **JS — init and request**
   - Payment History page (payment_history.js, class **PaymentHistory**) loads with **apiBaseURL** and **memberId**. Calls **getPortalDetail**.
2. **API**
   - **getPortalDetail** returns the same per-student data (currentSession, futureSession, pastSession; each session has invoiceList and breakDownList).
3. **JS — after response**
   - If there is no data: show a “no records” message and stop.
   - If there is data: build one tab per student. Fill each tab with **Outstanding invoices** (invoices not completed; user can pay from here) and **Payment history** (completed enrollments from current and past sessions, by year; user can download an itemized PDF per session via **generateItemizedInvoice**).

##### 2.2 Portal sidebar display

- **When there is portal data:** The page shows student tabs, Outstanding Invoices, and Completed Enrollments; the first student is selected by default.
- **When there is no data:** The page shows a “no records” message and hides the main content.
- **Sidebar:**  Whether the Payment History link is visible in the portal sidebar, at least 1 purchased program is available