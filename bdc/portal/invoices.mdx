---
title: "Invoices"
---

## Non-Technical

TODO: What users get to see & how they can use Invoices page.

The [Payment History](#) page allows parents to view students, track outstanding invoices, and complete pending payments.

### **How to Use**

- **Select a Student**\
  At the top of the page, all linked students are displayed. Click on a student to view their payment details.
- **View Outstanding Invoices**\
  Once a student is selected, all **pending or unpaid invoices** for that student appear below.
- **Check Invoice Details**\
  Click on **Invoice Breakdown** to see a detailed view of the charges, including tuition, discounts, deposits paid, and the remaining balance.

  ![Image](/images/image-33.png)
- **Make a Payment**\
  Choose a payment method (Credit/Debit Card or Bank Transfer) next to the invoice to proceed with payment via Stripe.
- **Track Payment Status**\
  After payment, the invoice status updates automatically. Once cleared, the **Outstanding Invoices** section shows **“No Invoices.”**
- **Completed Enrollments (usable for tax purposes)**

  After successful payment (or zero-amount enrollment), the record moves to **Completed Enrollments**.

  This section provides:
  - A historical view of completed enrollments by year
  - Downloadable **PDF receipts** for each enrollment

## Admins (Retool)

TODO: How can admin manage this on Retool. This section will probably be a little long, since we have a lot of invoice functionality. Explain bucket system, and how we handle pre-reg / bundled people.

## Technical

TODO: Explain in detail how the invoice system works (from Retool to rendering here). Include DB collections and relations. Explain itemized invoice logic. Explain invoice breakdowns.

Portal Invoices (Payment History page) shows per-student outstanding invoices and completed enrollments—one main JS file (`payment_history.js)` and API `getPortalDetail` (member-service).

**JS**

- File: `bcdc/payment_history.js`; class: `PaymentHistory`.
- Parent page must pass `apiBaseURL` and `memberId`: `new PaymentHistory({ apiBaseURL: '...', memberId: '...' });`.

**API**

- `GET getPortalDetail/{memberId}` (member-service, e.g. **getPortalDetails.py**). Builds per-student, per-session data (current, future, past); for each relevant payment calls `getInvoiceList(paymentId, email) → getInvoiceListScript `(MongoDB aggregation over `invoice_notifications` + lookups). Response shape is described in **Returns data** below.
- The portal does **not** call a dedicated invoice-only API. `getInvoiceList` runs aggregation on `invoice_notifications` (match `paymentId`), then joins `invoice_records`, `invoice_payment_link, invoice_responses, stripe_checkout_customer`.

**Returns data (invoice-specific)**

`getPortalDetail` returns an array of student objects. Each element is a single-key object: `key` = student name (string), `value` = student data object for that student.

**Student data object** (per student):

| Field              | Description                                                                                                 |
| :----------------- | :---------------------------------------------------------------------------------------------------------- |
| **currentSession** | Array of session objects for current-term enrollments (each has **invoiceList**).                           |
| **futureSession**  | Array of session objects for future-term enrollments (each has **invoiceList**).                            |
| **pastSession**    | Array of session objects for past/completed enrollments (used for Payment history / Completed Enrollments). |

**Session object** (each item in currentSession / futureSession / pastSession):

| Field           | Description                                                                  |
| :-------------- | :--------------------------------------------------------------------------- |
| **invoiceList** | Array of invoice objects for this payment/session (from **getInvoiceList**). |
| **createdOn**   | Session creation date (used for sorting students and sessions).              |
| **currentYear** | Year ID (used for Payment history rows and itemized PDF by year).            |

**Invoice object** (each item in **invoiceList**):

| Field              | Description                                                                                                                                                                                                                                              |
| :----------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **invoice_id**     | Invoice identifier (links to **invoice_records**.\_id).                                                                                                                                                                                                  |
| **invoiceName**    | Display name (from **invoice_records**.title).                                                                                                                                                                                                           |
| **is_completed**   | `true` if one **invoice_response** exists for this invoice + paymentId; else unpaid/pending.                                                                                                                                                             |
| **breakDownList**  | Object of line-item labels to amounts (see **Itemized invoice logic**). Keys include **Semester Tuition**, **New Student Fee**, **Sibling Discount**, **Early Bird**, **Deposit**. Used for Invoice Breakdown modal and to show/hide the breakdown link. |
| **jotFormUrlLink** | Array of payment options: **paymentLinkId**, **title**, **amount**, **paymentType** (e.g. `card`, `us_bank_account`). Used to render Pay                                                                                                                 |
| **status**         | Invoice/payment status.                                                                                                                                                                                                                                  |
| **paymentId**      | Payment identifier.                                                                                                                                                                                                                                      |
| **created_on**     | When the invoice notification was created (used for sorting outstanding invoices).                                                                                                                                                                       |

**Where the data lives (DB)**

**invoice_notifications** — Links a payment to an invoice. Created/updated by admin (Retool). Used as the base for `getInvoiceListScript` aggregation (match `paymentId`).

| Field          | Description                        |
| :------------- | :--------------------------------- |
| **paymentId**  | Payment identifier.                |
| **invoice_id** | Links to **invoice_records**.\_id. |
| **emailId**    | Email identifier.                  |
| **created_on** | When the notification was created. |

**invoice_records** — One document per invoice (e.g. semester bucket). Looked up by `invoice_id` in aggregation.

| Field              | Description                                                  |
| :----------------- | :----------------------------------------------------------- |
| **\_id**           | MongoDB ObjectId (= invoice_id).                             |
| **title**          | Invoice name (shown as **invoiceName** on portal).           |
| **returner**       | Whether the student is a returner (affects New Student Fee). |
| **sibling**        | Whether sibling discount applies.                            |
| **earlyBirds**     | Whether early-bird discount applies.                         |
| **currentYear**    | Year ID (used with **invoice_rates**).                       |
| **classSessionId** | Session ID (used with **invoice_rates**).                    |
| **payment_type**   | e.g. `"bucket"`.                                             |

**invoice_rates** — Pricing and discounts by year/session. Used by `calculatebucketAmount` for `breakDownList`.

| Field                     | Description                 |
| :------------------------ | :-------------------------- |
| **yearId**                | Year identifier.            |
| **classSessionId**        | Session identifier.         |
| **basePrice**             | Semester tuition.           |
| **newStudent**            | New student fee.            |
| **siblingDiscPercentage** | Sibling discount (%).       |
| **earlyBirdsDiscount**    | Early-bird discount amount. |

**invoice_payment_link** — One or more payment options per invoice (card, ACH, form, etc.). Looked up by `invoice_id` in aggregation.

| Field           | Description                   |
| :-------------- | :---------------------------- |
| **invoice_id**  | Links to **invoice_records**. |
| **paymentType** | e.g. card, us_bank_account.   |
| **amount**      | Payment amount.               |
| **title**       | Link title.                   |
| **jotFormUrl**  | URL for form-based payment.   |
| **formid**      | Form identifier.              |

**invoice_responses** — One per successful (or attempted) invoice payment. Written by Stripe webhook. Looked up by `invoice_id + paymentId` in aggregation.

| Field                                                     | Description                               |
| :-------------------------------------------------------- | :---------------------------------------- |
| **invoiceId**                                             | Invoice identifier.                       |
| **paymentId**                                             | Payment identifier.                       |
| **paymentLinkId**                                         | Payment link used.                        |
| **memberId**                                              | Member identifier.                        |
| **amount**                                                | Amount paid.                              |
| **payment_intent**                                        | Stripe payment intent.                    |
| **status**                                                | Payment status.                           |
| **credit_amount**                                         | (After completion) For itemized receipts. |
| **basePrice**, **newStudent**, **sibling**, **earlyBird** | (After completion) For itemized PDFs.     |

**stripe_checkout_customer** — Created when user starts Stripe checkout for an invoice. Looked up by `invoice_id + paymentId` in aggregation.

| Field              | Description              |
| :----------------- | :----------------------- |
| **invoiceId**      | Invoice identifier.      |
| **paymentId**      | Payment identifier.      |
| **paymentLinkId**  | Payment link identifier. |
| **memberId**       | Member identifier.       |
| **status**         | Checkout status.         |
| **payment_intent** | Stripe payment intent.   |

### Itemized invoice(bucket breakdown)

- \*\*breakDownList \*\*shown on the portal for each invoice is computed by `calculatebucketAmount(invoiceRecord) `. It uses `invoice_rates` for the invoice’s `currentYear` and `classSessionId`.
- **breakDownList** (bucket breakdown) — keys and meaning:
  - **Semester Tuition** — **invoice_rates**.basePrice.
  - **New Student Fee** — **invoice_rates**.newStudent (if not returner).
  - **Sibling Discount** — negative amount from **invoice_rates**.siblingDiscPercentage.
  - **Early Bird** — negative **invoice_rates**.earlyBirdsDiscount (if earlyBirds).
  - **Deposit** — fixed amount (e.g. 300)
- It shows `basePrice, newStudent, sibling, earlyBird, and credit_amount`

**Sidebar and main content**

- **Main content** depends on `getPortalDetail` response:
  - **Has portal data:** Show the Payment History UI (student tabs, Outstanding Invoices, Completed Enrollments / Payment history). First student is selected by default; `.portal-info-wrapper` and `.portal-tab`.
  - **No data** (e.g. "No data Found"): Show `[data-container="no-record-found"]`, hide `.portal-info-wrapper` and spinner (`#half-circle-spinner`).

**Flow**

1. **JS (PaymentHistory)** — init and request
   - Constructor receives `data` with `apiBaseURL` and `memberId`.
   - Caches DOM: `#half-circle-spinner`, `[data-container="no-record-found"]`, `.portal-info-wrapper`, `.portal-tab-menus`, `.portal-tab-content`, `.portal-tab-link`, `.portal-tab-pane`.
   - **render()** hides content, shows spinner; calls` fetchData() → GET getPortalDetail/;` if response is "No data Found" → show no-record, hide spinner; return. Otherwise continue.
2. **API (getPortalDetail)**
   - `getPortalDetail/ `builds per-student, per-session data; for each relevant payment calls `getInvoiceList → getInvoiceListScript`. Returns array of student objects (see **Returns data**). Each student has `currentSession, futureSession, pastSession with invoiceList and breakDownList` per session.
3. **JS (PaymentHistory)** — after response
   - `setupTabs(data)`**:** Build one tab per student;  `renderStudentTab` fills each pane with `renderOutstandingInvoices` + `renderPaymentHistory`.
   - **Outstanding invoices** (`[data-payment="outstanding-invoice"]`): Show `invoiceList` where the **invoice is not completed**. Per invoice: icon, **invoiceName**, "Invoice Breakdown" link, and pay now button(Bank Transfer, Credit/Debit Card).
   - **Invoice breakdown:** `initializeInvoiceBreakdownLinks()` — click on `.invoice-breakdown-link` opens modal with `breakDownList` (Semester Tuition, Early Bird, New Student Fee, sibling discount, Deposit) and remaining balance.
   - **Payment history** (`[data-payment="payment-history"]`): Sessions from `currentSession `\+ `pastSession `by year; per session, download icon calls `generateInvoicePDF` → POST `generateItemizedInvoice`.
   - **Invoice Stripe payment:** `initializeStripePayment `— POST `createCheckoutUrl `(amount in cents, invoiceId, paymentId, etc.); on success redirect to Stripe.