---
title: "Invoices"
---

## Non-Technical

TODO: What users get to see & how they can use Invoices page.

The [Payment History](https://www.bergendebate.com/portal/payment-history) page allows parents/admins to view students, track outstanding invoices, and complete pending payments.

### **How to Use**

- **Select a Student**\
  At the top of the page, all linked students are displayed. Click on a student to view their payment details.
- **View Outstanding Invoices**\
  Once a student is selected, all **pending or unpaid invoices** for that student appear below.
- **Check Invoice Details**\
  Click on **Invoice Breakdown** to see a detailed view of the charges, including tuition, discounts, deposits paid, and the remaining balance.

  ![Image](/images/image-33.png)
- **Make a Payment**\
  Choose a payment method (Credit/Debit Card or Bank Transfer) next to the invoice to proceed with payment via Stripe.
- **Track Payment Status**\
  After payment, invoice status updates automatically, helping users track completed and pending payments easily. The Outstanding Invoices Section will show - No Invoices.

## Admins (Retool)

TODO: How can admin manage this on Retool. This section will probably be a little long, since we have a lot of invoice functionality. Explain bucket system, and how we handle pre-reg / bundled people.

## Technical

TODO: Explain in detail how the invoice system works (from Retool to rendering here). Include DB collections and relations. Explain itemized invoice logic. Explain invoice breakdowns.

### Overview

The invoice system flows from **Retool (admin)** creating and linking invoice data, through **member-service** aggregating it per student/session, to the **portal** rendering an accordion and handling Stripe payment. After payment, **scheduler_service** (Stripe webhook) writes **invoice_responses** and updates credits. Separate APIs support **payment history / itemized receipts** (e.g. **getSemesterInvoiceDataV2**, **generateItemizedInvoice** / **generateInvoicePDF**).

### API and data source for the portal

- **Portal invoice list:** The portal does **not** call a dedicated invoice API. It calls **GET getPortalDetail/** (member-service, **getPortalDetails.py**). The response is built per student and per session (current, future, past); for each relevant payment the API calls **getInvoiceList(paymentId, email)**.
- **getInvoiceList** uses **getInvoiceListScript(emailId, paymentId)** (in **memberScript.py** / **invoiceScript.py**), which runs a MongoDB aggregation on **invoice_notifications** (matched by **paymentId**), then joins **invoice_records**, **invoice_payment_link**, **invoice_responses**, and **stripe_checkout_customer**.
- Each item in **invoiceList** includes: **invoice_id**, **invoiceName** (from invoice_records.title), **is_completed** (true if there is at least one invoice_response for that invoice + paymentId), **breakDownList** (bucket breakdown, see below), **jotFormUrlLink** (array of payment links with **paymentLinkId**, **title**, **amount**, **paymentType**, **jotFormUrl**, **formid**), **status**, **paymentProcessMsg**, **paymentId**, **created_on**.

### DB collections and relations

| Collection                   | Role                                                                          | Key relations                                                                                                                                                                                                                |
| ---------------------------- | ----------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **invoice_notifications**    | Links a payment to an invoice. Created/updated by admin (Retool).             | **paymentId**, **invoice_id**, **emailId**, **created_on**                                                                                                                                                                   |
| **invoice_records**          | One document per invoice (e.g. semester bucket).                              | **\_id** = invoice_id; **title**, **returner**, **sibling**, **earlyBirds**, **currentYear**, **classSessionId**, **payment_type** (e.g. `"bucket"`)                                                                         |
| **invoice_rates**            | Pricing and discounts by year/session.                                        | **yearId**, **classSessionId** → **basePrice**, **newStudent**, **siblingDiscPercentage**, **earlyBirdsDiscount**                                                                                                            |
| **invoice_payment_link**     | One or more payment options per invoice (card, ACH, form, etc.).              | **invoice_id**, **paymentType**, **amount**, **title**, **jotFormUrl**, **formid**                                                                                                                                           |
| **invoice_responses**        | One per successful (or attempted) invoice payment. Written by Stripe webhook. | **invoiceId**, **paymentId**, **paymentLinkId**, **memberId**, **amount**, **payment_intent**, **status**; after completion also **credit_amount**, **basePrice**, **newStudent**, **sibling**, **earlyBird** (for itemized) |
| **stripe_checkout_customer** | Created when user starts Stripe checkout for an invoice.                      | **invoiceId**, **paymentId**, **paymentLinkId**, **memberId**, **status**, **payment_intent**                                                                                                                                |

- **getInvoiceListScript** aggregates: **invoice_notifications** (match **paymentId**) → lookup **invoice_records** by **invoice_id** → lookup **invoice_payment_link** by **invoice_id** → lookup **invoice_responses** by **invoice_id** + **paymentId** → lookup **stripe_checkout_customer** by **invoice_id** + **paymentId**. So portal invoice list is “all notifications for this payment” with joined record, links, responses, and checkout status.

### Itemized invoice logic (bucket breakdown)

- **breakDownList** shown on the portal for each invoice is computed by **calculatebucketAmount(invoiceRecord)** (in **getPortalDetails.py** / **validatePortalAPIs.py**). It uses **invoice_rates** for the invoice’s **currentYear** and **classSessionId**.
- Logic:
  - If **invoiceRecord** has no **returner**, a default `{"Deposit": 300.0}` can be used (scheduler_service variant); otherwise, rates apply.
  - **Semester Tuition** = **invoice_rates.basePrice**.
  - **New Student Fee** = **invoice_rates.newStudent** if the student is not a **returner**.
  - **Sibling Discount** = −(basePrice × **siblingDiscPercentage** / 100) if **sibling** is true.
  - **Early Bird** = −**earlyBirdsDiscount** if **earlyBirds** is true.
  - **Deposit** = 300 (fixed) in the member-service version.
- This **breakDownList** is returned in **getInvoiceList** so the portal can show a line-item breakdown when needed. The same bucket logic is used in **stripePaymentListener** when completing an invoice payment: it writes **basePrice**, **newStudent**, **sibling**, **earlyBird**, **credit_amount** onto **invoice_responses** for use in itemized receipts and PDFs.

### Invoice breakdowns (line items)

- **Breakdown keys** returned by **calculatebucketAmount** (and stored on **invoice_responses** after payment) are: **Semester Tuition**, **New Student Fee**, **Sibling Discount**, **Early Bird**, **Deposit**, and optionally **credit_amount** (credits applied).
- For **payment history / PDF receipts**, **getSemesterInvoiceDataV2** (payment-checkout-service, **invoiceScript.getSemesterInvoiceDataV2**) aggregates **invoice_responses** with **invoice_records**, **invoice_payment_link**, **payment_details**, **class_details**, **class_location**, **class_level**, **class_session**, **members** to produce per-invoice line items (studentName, location, session, basePrice, newStudentFee, siblingDisc, earlyBirdsDiscount, credit_amount, amount, etc.).
- **generateItemizedInvoice** / **generateInvoicePDF** (payment-checkout-service) build itemized receipts and PDFs from **invoice_responses** and related payment/class data, including bundle/pre-reg logic (e.g. **get_root_payments**, **get_bundle_children** over **payment_details**, **summer_payment_details**, **topic_payment_details**).

### Portal rendering (JS)

- **JS file:** **portal_new_ui.js** (or **portal_staging.js**), **Portal** class.
- **Flow:** **fetchData()** calls **getPortalDetail/**. **render()** then calls **setupTabs(data, …)** which, for each student tab, gets **student** from **data** (keyed by student name) with **pastSession**, **currentSession**, **futureSession**. Invoices come from **student.invoiceList** and **studentData.futureSession[].invoiceList**; these are merged and passed to **renderInvoiceAccordionStyled(tabPane, student, studentData)**.
- **renderInvoiceAccordionStyled** finds **[data-portal="invoice-form-accordian"]** in the tab pane, clears it, and builds the accordion: header (“Invoices”, “Needs to be completed” / “All Paid”), completion progress (X of Y invoices complete, %), then one block per invoice with **invoiceName**, status (Paid/Pending), and action links. For unpaid invoices, **jotFormUrlLink** is used: if **paymentType** is card or us_bank_account, a “Pay” link calls **initializeStripePayment(invoice_id, invoiceName, amount, paymentLinkId, …)**; otherwise a link opens **jotFormUrl**.
- **initializeStripePayment** sends a request to create a Stripe Checkout session (invoiceId, paymentId, paymentLinkId, etc.); the user is redirected to Stripe. On success, the webhook (**stripePaymentListener.updateInvoiceResponses**) inserts/updates **invoice_responses** and updates **member_credit_amount** when credits are applied. **renderFailedInvoiceNotification** shows a banner if any **invoiceList** item has **status === 'Failed'**.
- **initializeInvoiceAccordion** wires click handlers so only one invoice accordion is open at a time.

### Pre-reg / bundled students

- **invoiceList** is attached per **paymentId** for both `**currentSession**` and **futureSession** in **getPortalDetails**. So pre-reg or bundled students see invoices for their placeholder/future payment in the same way; **getInvoiceList** is called with that payment’s **paymentId** and parent **email**. Bucket breakdown and payment links are the same as for regular semester invoices.