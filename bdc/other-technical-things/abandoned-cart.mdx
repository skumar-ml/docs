---
title: "Abandoned Cart"
---

## Non-Technical

This feature reminds users to complete their purchase if they added a program to the cart but did not finish the checkout.

### Where the user sees this

**1. Cart Icon (Top-right corner of the navbar)**

<Frame>
  ![Image](/images/image-139.png)
</Frame>

- When the user hovers on the cart icon: \
  If no program is added → _“No record found”_ with **View Programs.**

  <Frame>
    ![Image](/images/image-135.png)
  </Frame>
- **Click “View Programs”** → Navigates to the [Classes Overview](https://www.bergendebate.com/classes-overview) page. From there, click **“Register Now”** to go to the Programs page.
- **If a program is added and checkout is pending** → The cart popup shows the **Program name**, **Location**, and a **“Resume Checkout”** option.

  <Frame>
    ![Image](/images/image-137.png)
  </Frame>

**2. Abandoned Popup**\
When the user revisits the site or opens the dashboard with a pending cart:

- A popup appears showing: Program, Location, User name, **Complete Purchase** and **Continue Browsing**. Clicking **Complete Purchase** will take you to the program’s checkout page.\
  Clicking **Continue Browsing** will close the popup.
- It appears only if your saved cart is still recent and you haven’t dismissed the popup recently.

<Frame>
  ![Image](/images/image-134.png)
</Frame>

## Technical

### Data & Storage

- **Persistent cart record (database)**:\
  When a user reaches checkout with a program in their cart, the backend saves a **checkout record** for that user (keyed by `memberId`). This record includes : `createdOn`, `levelId`, `locationId` / `location`, and `firstName` / `studentName` / `lastName`.

<Note>
  TODO: In which collection is it saved?
</Note>

- **Browser storage (localStorage)**:\
  The frontend mirrors the last checkout record in `localStorage` under the key `checkOutData` to show the abandoned-cart UI without hitting the API.\
  It also stores `isAbandonedModalOpen` and `lastModalClosedDate` to enforce a “show at most once every 7 days” rule.

### APIs

- **Get abandoned cart by member (BDC)**
  - Endpoint: `GET /getCheckoutUrlByMemberId/{memberId}`
  - Used when `checkOutData` is missing from `localStorage`.
  - Returns a JSON object with the fields listed above (`createdOn`, level/location, student name, etc.).
- The frontend never writes directly to the database; it only **reads** the last checkout for the logged-in member via this API and then caches it in `localStorage`.

### Frontend flow

1. **Initialization**
   - On most pages (excluding `/cart/*` and `log-in`), the `AbandonedCartModal` JS class runs on page load.
   - It receives config such as `baseUrl`, `memberId`, `modalId`, and `hour` (minimum age in hours before we consider a cart “abandoned”, currently it's set to 6 hours).
2. **Load cart data**
   - The script first looks for `checkOutData` in `localStorage`.
   - If not found, it calls the **Get checkout by member** API, then saves the response into `localStorage` as `checkOutData`.
3. **Eligibility checks before showing anything**\
   The modal will only show if **all** of these pass:
   - Cart age is older than `hour` hours (e.g. \> 6 hours) based on `createdOn`.
   - Cart age is **younger than 5 months** (older carts are ignored).
   - If the user previously closed the popup (continue browsing or close icon), at least **7 days have passed** since `lastModalClosedDate`.
   - The **current selling session has started**:
     - If the cart’s `createdOn` is **before** that selling start date **and** today is **on/after** that date, the script treats the cart as belonging to an old season.
     - In that case it removes `checkOutData` from `localStorage` and does **not** show the abandoned-cart UI, so users are never prompted to finish checkout for last season’s programs.
4. **Update cart icon / mini-cart**
   - Regardless of whether the modal opens, the script uses the `checkOutData` values to populate the **cart icon hover menu** using elements marked with `data-cart-menu` attributes (e.g. `programName`, `programDate`, `studentName`, and location).
   - If there is no valid cart in `localStorage`, it shows the “No record found” state.
5. **Show abandoned-cart modal**
   - If all checks pass, the script:
     - Adds the `show` class to the abandoned-cart modal and sets its display to `flex`.
     - Builds the **“View Cart / Complete Purchase”** link by combining `window.location.origin` with the program identifier from `checkOutData`:
       - Uses `levelId` to create a `/programs/level-{levelId}?returnType=back` URL.
6. **User actions & cooldown**
   - When the user closes the modal (close icon or “Continue Browsing”), the script sets `isAbandonedModalOpen=true` and updates `lastModalClosedDate` in `localStorage`.
   - These values are checked on subsequent visits to ensure the reminder is not shown again for **7 days**, even if the cart is still present.

Overall, the feature is **stateless on the server side** beyond the checkout record itself: all reminder timing and display rules are enforced in the browser using `localStorage` plus a single read-only API to fetch the latest cart.