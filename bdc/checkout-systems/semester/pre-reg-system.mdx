---
title: "Pre-Reg System"
---

Pre-registration allows eligible students to register earlier than the public enrollment so they can secure class spots before regular registration opens. This document explains: (1) the different pre-registration states; (2) what users see in each state; (3) how admins can control and manage these states using Retool.

Pre-registration typically runs **at least one-week** before the start of the general enrollment.

## The Three Pre-Registration States

### 1. Normal Registration State

**This is the default experience** for most users. In this state, pre-registration is not active _and_ the user is not pre-registered for the semester. **User's see** the standard registration and checkout flow.

### 2. Pre-Registration Information State

This state shows **when** pre-registration is currently active, but the user is _not_ pre-registered for the semester.

The user **sees** (1) a banner message that "Registration is currently open only for Year-Long Bundle students"; (2) a countdown timer showing when pre-registration ends; (3) and some information explaining the benefits of pre-registering for future semesters.

### 3. Bundle Purchase State

This state occurs **when** we recognize the student as having pre-registered for the semester, allowing for early enrollment.

<Note>
  If pre-registration is active, the user can only enroll pre-registered students (they cannot enroll a _different student_).
</Note>

Pre-registered users will see that the standard “Pay Now” button is replaced with a “Pre-Register” button. Users can select class locations and times and complete enrollment without payment. Payment is required only if additional programs are added.

## Common Scenarios

| Scenario                             | State                 | User Experience                |
| :----------------------------------- | :-------------------- | :----------------------------- |
| New user during pre-registration     | Pre-Registration Info | Sees upgrade and discount info |
| Bundle owner during pre-registration | Bundle Purchase       | Can pre register               |
| After pre-reg ends                   | Normal                | Standard registration          |

## Retool: Admin Control & Management

Admins manage pre-registration behavior through **Retool**.

<Note>
  TODO: Need to explain

  1. how admin can see who is pre-registered for a semester
  2. how admin can change dates pre-registration is active on the website
</Note>

### Bundle Management Program Retool Page

Admins can view the list of bundle users on the **Bundle Management** Retool page. The page includes filters for **Year**, **Session**, **Parent**, and **Student**, allowing admins to quickly narrow down results.

It displays **student details**, **parent details**, and **class information**, along with options to **switch programs** or **process refunds**.

Additionally, admins can add a new bundle program using the **“Add Bundle Program”** button.

![Image](/images/image-5.png)

In Retool, admins can:

- **Add** new students as pre-registered for any future semester
- **Switch** a student's pre-registration to a different semester
- **Remove** a student's pre-registration status

## Technical Details

<Note>
  TODO: SK needs to review this section
</Note>

TODO: Give a technical explanation of how these states are calculated for each user. How the user can "auto-enroll" without making a payment.

### Pre-Registration & Auto-Enrollment State Logic

This section explains how the frontend determines a user’s pre-registration state and when payment is required.

### Overview

The frontend determines a user’s state by calling the backend API `getYearLongBundleDetails/webflowMemberId`

Based on the API response (`message` and `data`), the frontend calculates the current **user state** and decides: (1) what UI to show; (2) whether the user can **auto-enroll**; (3) whether payment is required or not

## API Response Structure

The API returns the following fields:

```
{
  "message": "string",
  "data": [],
  "preRegistrationEndDate": "YYYY-MM-DD"
}
```

| Field                    | Purpose                                                     |
| :----------------------- | :---------------------------------------------------------- |
| `message`                | Indicates the current phase of pre-registration             |
| `data`                   | Contains bundle details if the user is eligible to purchase |
| `preRegistrationEndDate` | Used for countdowns                                         |

## State Determination Logic

The frontend evaluates the response using the following logic

### 1. **Normal**

**Condition**

- `message = "Either pre-registration not yet started or already ended"`
- `data.length = 0`

**Meaning**

Pre-registration has not started or has already ended. Users proceed with standard enrollment and payment if applicable.

### 2. **Pre-Registration-Info**

**Condition**

- `message = "Pre-registration is going on"`
- `data.length = 0`

**Meaning**

Pre-registration is active, but the user has no eligible bundle data. Only informational banners and countdowns are shown.

### 3. **Bundle-Purchase**

**Condition**

- `message = "Pre-registration is going on"`
- `data.length > 0`

**Meaning**

Pre-registration is active and bundle data exists. The user can select classes and complete pre-registration. If no add-ons are selected, enrollment completes **without payment**. Payment is required only when optional bundle programs are added.

## Pre-Reg Payment

When a user clicks “**Pre-Register**”, the system initiates the payment using the same `initializeStripePayment()` method as the standard checkout flow. Along with the usual payment data, the request includes the bundle-specific `paymentId` ********`<TODO: remind briefly what paymentId is used for..?><Comment: The paymentId is the MongoDB ObjectId (_id) of the original payment record in the payment_details collection. During this purchase, the user also bought a bundle program, which now needs to be pre-registered.>`********, a flag indicating a bundle purchase `(isBundleProgram: true)`, and the selected `classUniqueId`.

For bundle purchases, the API endpoint is chosen based on whether the user has selected any upsell programs or briefs.

~~If the pre-registration includes upsells or briefs, the system routes the request to the ~~`checkoutUrlForUpsellProgram`~~API. This creates a separate Stripe checkout session for the pre-registration with Upsell programs or briefs.~~

~~If the pre-registration does not include upsells or briefs, the system calls the ~~`updateDataToCheckoutUrl`~~API. In this case, the existing checkout session—identified by the checkoutId—is updated with the pre-registration and class selection details. The corresponding ~~ `stripe_checkout_customer`~~records are updated, and the API returns the latest cardUrl and achUrl for redirecting the user to Stripe Checkout.~~

If the pre-registration includes a **bundle or briefs**, the system routes the request to the **checkoutUrlForUpsellProgram** API. This API creates a **new Stripe Checkout Session** for the pre-registration with the selected bundle or briefs, inserts/updates the corresponding records in the **stripe_checkout_customer** collection, and returns the **cardUrl** and **achUrl** for redirecting the user to Stripe Checkout.

If the pre-registration **does not include any bundle or briefs**, the system does **not** create a new checkout session. Instead, it updates only the **payment_details** collection using the existing **paymentId**, adding the pre-registration and class selection details. In this case, the **stripe_checkout_customer** collection is not modified, and no new Stripe URLs are returned.

<Note>
  TODO: Isn't this last part wrong? Why does the API return cardUrl and achUrl? It should just pre-register them... \
  \
  Perhaps you meant to add it to the above, where the pre-registration includes upsells/briefs.
</Note>