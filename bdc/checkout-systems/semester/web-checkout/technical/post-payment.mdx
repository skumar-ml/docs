---
title: "Post-Payment (After Successful Checkout)"
---

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

### Core Logic Flow (High Level)

After a payment is completed, Stripe sends a webhook to our system.\
The webhook determines the payment status and routes the event to the correct handler.\
For class purchases, all post-payment logic is handled by `updateClassPayment()`. also it's handle Enrollment, referrals, coupons, waitlist cleanup and email

1. Stripe sends webhook → `stripePaymentListener`
2. Payment status is derived (`Complete`, `Processing`, `Failed`)
3. `updateClassPayment()` is invoked
4. System updates payment records
5. Enrollment, referrals, coupons, waitlist cleanup occur
6. Emails are triggered

### `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates. This API acts as the single entry point for all post-payment processing.

### What this API does

- Validates the Stripe webhook signature
- Extracts the `payment_intent` and checkout metadata
- Loads the corresponding record from `stripe_checkout_customer`
- Normalizes Stripe event data into internal payment statuses:
  - **Complete** → Payment confirmed and funds captured
  - **Processing** → Bank transfer or async payment still pending
  - **Failed** → Payment failed or was canceled
- Routes the event to the appropriate handler:
  - `updateClassPayment()` for class purchases
- Ensures idempotency so repeated webhooks do not create duplicates

### Behavior by payment status

- **Complete**
  - Triggers full post-payment processing
  - Enrollment, referrals, credits, and emails are executed
- **Processing**
  - Stores payment as pending
  - Enrollment is deferred until final confirmation
- **Failed**
  - Cleans up partial payment records
  - Prevents enrollment or benefit application

### `updateClassPayment()`

`updateClassPayment()` is the **core business orchestration layer** for class purchases.\
It executes **all database writes, enrollment logic, referral handling, and cleanup** associated with a payment.

### Responsibilities

- Determines whether the payment is new or already processed (idempotency)
- Handles logic based on payment status (`Complete`, `Processing`, `Failed`)
- Persists payment and checkout state
- Applies all side effects tied to a successful purchase

All sections below execute under this function unless explicitly skipped due to failure or pending status.

## Database Writes & Updates

### A. `payment_details`

- **Insert (first successful payment)**:
  - payment_intent
  - amount
  - studentId
  - classId
  - memberId
  - device & UTM metadata
  - couponCode (if applied)
- **Update (subsequent webhook calls)**:
  - status
  - receipt_url

### B. `stripe_checkout_customer`

- Updated on every webhook event:
  - payment_intent
  - status (Complete / Processing / Failed)

### C. Failure Handling

- If payment **fails**:
  - Delete `payment_details`
  - Delete upsell payments
  - Mark checkout status as Failed

---

## Referral & Coupon Processing

- If a coupon is used:
  - Referral marked as `Purchased`
  - Purchased date updated
- If no existing coupon for family:
  - New **referral coupon** is generated
  - Coupon created in Stripe
  - Coupon stored in `coupon_details`

---

## Trial → Paid Conversion

- If parent previously attended a trial class:
  - `trial_class_details.status` updated to `Purchased`

---

## Enrollment & Cleanup

- **Waitlist cleanup**:
  - Removes student from `waitlist_details` for the purchased class
- **Upsell Programs** (if any):
  - Inserted into `upsell_payment_details`
- **Topic Purchases** (if any):
  - Inserted into topic payment collection

---

## Credit & Discounts

- If discount or credit is applied:
  - Credit balance is updated
  - Linked to yearId & sessionId

---

## Emails Triggered

### Automated Emails

- **Admin Notification**
  - Sent on successful payment
  - Includes order & enrollment details
- **User Emails** (implicit via Stripe receipt)
  - Stripe receipt URL stored in DB

---

---

## Key Characteristics

- Webhook-driven (idempotent by `payment_intent`)
- Safe for retries
- Handles partial & async payments
- Centralized post-payment orchestration

---

This flow ensures financial consistency, enrollment accuracy, referral tracking, and reliable user communication after every payment.