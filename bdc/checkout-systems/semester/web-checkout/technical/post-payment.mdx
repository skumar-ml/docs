---
title: "Post-Payment (After Successful Checkout)"
---

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

## Core Logic Flow

After a payment is completed, Stripe sends a webhook to our system.\
The webhook determines the payment status and routes the event to the correct handler.\
For class purchases, all post-payment logic is handled by `updateClassPayment()`.

## `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates . This API acts as the single entry point for all post-payment processing.

This webhook (1) validates the Stripe webhook signature and extracts the `payment_intent` with checkout metadata; (2) finds the related record from `stripe_checkout_customer` and normalizes the event into internal payment states (Complete, Processing, Failed); (3) Based on the payment state, triggers the next functions.

<Note>
  TODO:

  1. **How is the event normalized into internal payment states? Unclear right now**
  2. **What is the unique key from Stripe used to find the related record in** `stripe_checkout_customer`?
</Note>

\
The webhook ensures idempotency so repeated webhooks do not create duplicates.

<Note>
  **\<TODO: Explain how you ensure idempotency\>.**
</Note>

### Behaviour by payment status

- **Complete**: When a payment is marked as **Complete**, full post-payment processing is triggered via `updateClassPayment()`.
- **Processing**: For **Processing** payments, the payment is stored as pending. **\<TODO: stored as pending where?\>**
- **Failed**: For **failed** payments, all partial or temporary records are cleaned up.\
  No enrollment, credits, or referrals are applied.

### `updateClassPayment()`

`updateClassPayment()` is the **core business orchestration layer** for class purchases.\
It executes **all database writes, enrollment logic, referral handling, coupons, waitlist cleanup, and automated emails** associated with a payment.

Determines whether the payment is new or already processed (idempotency), then handles logic based on payment status (Complete, Processing, Failed).\
Persists payment and checkout state and applies all side effects associated with a successful purchase.

All sections below execute under this function unless explicitly skipped due to failure or pending status.

## Database Writes & Updates

### A. `payment_details`

- On the **first successful payment** (based on `payment_intent`), **we insert:**  payment_intent, payment_intent, amount, studentId, classId, memberId, device, UTM metadata, and couponCode (if applied).
- On subsequent webhook calls (with the same `payment_intent`), we update the `status` and `receipt_url`.

### B. `stripe_checkout_customer`

On every webhook event, we update the `payment_intent` & `status` (Complete / Processing / Failed).

<Note>
  TODO: I thought `payment_intent` was the unique identifier? If it's not, than what is the unique identifier for `stripe_checkout_customer`, that you get from Stripe?
</Note>

### C. Failure Handling

If payment fails, we delete the payment details and any upsell payments, and mark the checkout `status` as Failed in `stripe_checkout_customer`.

## Referral & Coupon Processing

**If a coupon is used**, Stripe passes it as **\<TODO: insert\>**. We search to see if the coupon exists in **\<TODO: insert referral collection\>**. If a match is found, we mark the referral as Purchased and update the purchase date.

For any purchase, we check to see if the family (identified via their `familyId`) has a coupon in **\<TODO: insert collection\>**. If it does not exist, we generate **\<TODO: how?\>** a new referral coupon, create it in Stripe **\<TODO: are there any restrictions applied to this coupon?\>**, and store it in `coupon_details`.

<Note>
  TODO: I rewrote this part to add more detail. Please fill in the TODOs. We'll need to give more details about the referral section in a different page, but this should be sufficient for payment purposes.
</Note>

## Trial â†’ Paid Conversion

If the parent previously attended a trial class, the corresponding `trial_class_details`  is updated to `Purchased`. The lookup is performed via **\<TODO: explain\>**.

## Enrollment & Cleanup

- **Waitlist cleanup**: Searches for student in the `waitlist_details` via **\<TODO: what key is used to search\>**. If found, then they are removed from the waitlist via deletion.
- **Upsell Programs** (if any): Inserted into `upsell_payment_details`
- **Topic Purchases** (if any): Inserted into topic payment collection

<Note>
  TODO: We'll likely need a seperate note to more thoroughly explain how upsells work. I'll figure out the right structure.
</Note>

## BDC Credit

If BDC credits were applied by the user, their credit balance is updated. \<TODO: how do we know if BDC credits were used; how is search done and in what collection.\>

## Emails Triggered

### Automated Emails

- **Admin Notification: **Sent on successful payment. Includes order & enrollment details
- **User Emails: **Automatically triggered receipt via Stripe. Same as the receipt_url stored in `payment_details`.

---

---