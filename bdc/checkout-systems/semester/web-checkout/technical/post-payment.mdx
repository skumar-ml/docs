---
title: "Post-Payment (After Successful Checkout)"
---

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

### Core Logic Flow

After a payment is completed, Stripe sends a webhook to our system.\
The webhook determines the payment status and routes the event to the correct handler.\
For class purchases, all post-payment logic is handled by `updateClassPayment()`. also it's handle Enrollment, referrals, coupons, waitlist cleanup and email

### `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates. This API acts as the single entry point for all post-payment processing.

### What this Webhook does

Validates the Stripe webhook signature and extracts the `payment_intent` with checkout metadata.\
Loads the related record from `stripe_checkout_customer` and normalizes the event into internal payment states (Complete, Processing, Failed).\
Routes the event to the correct functions (e.g., `updateClassPayment()` for class purchases).\
Ensures idempotency so repeated webhooks do not create duplicates.

### Behaviour by payment status

- **Complete**: When a payment is marked as **Complete**, full post-payment processing is triggered.\
  This includes database updates, enrollment, referrals, credits, cleanup, and emails.
- **Processing**: For **Processing** payments, the payment is stored as pending.
- **Failed**:For **failed** payments, all partial or temporary records are cleaned up.\
  No enrollment, credits, or referrals are applied.

### `updateClassPayment()`

`updateClassPayment()` is the **core business orchestration layer** for class purchases.\
It executes **all database writes, enrollment logic, referral handling, and cleanup** associated with a payment.

Determines whether the payment is new or already processed (idempotency), then handles logic based on payment status (Complete, Processing, Failed).\
Persists payment and checkout state and applies all side effects associated with a successful purchase.

All sections below execute under this function unless explicitly skipped due to failure or pending status.

## Database Writes & Updates

### A. `payment_details`

- **Insert (first successful payment)**:

  We insert payment_intent, payment_intent, amount, studentId, classId, memberId, device & UTM metadata and couponCode (if applied)
- **Update (subsequent webhook calls)**:

  After successful payment, we update the  status and receipt_url

### B. `stripe_checkout_customer`

Updated on every webhook event:

- payment_intent
- status (Complete / Processing / Failed)

### C. Failure Handling

If payment fails, delete payment details and any upsell payments, and mark the checkout status as \*\*Failed \*\*in the `stripe_checkout_customer` collection

## Referral & Coupon Processing

If a coupon is used, mark the referral as Purchased and update the purchase date; if no family coupon exists, generate a new referral coupon, create it in Stripe, and store it in `coupon_details`.

## Trial â†’ Paid Conversion

If the parent previously attended a trial class, the corresponding `trial_class_details` The record is updated to `Purchased`.

## Enrollment & Cleanup

- **Waitlist cleanup**:
  - Removes student from `waitlist_details` for the purchased class
- **Upsell Programs** (if any):
  - Inserted into `upsell_payment_details`
- **Topic Purchases** (if any):
  - Inserted into topic payment collection

---

## Credit & Discounts

If credits or discounts are applied, the credit balance is updated.

## Emails Triggered

### Automated Emails

- **Admin Notification**
  - Sent on successful payment
  - Includes order & enrollment details
- **User Emails** (implicit via Stripe receipt)
  - Stripe receipt URL stored in DB

---

---