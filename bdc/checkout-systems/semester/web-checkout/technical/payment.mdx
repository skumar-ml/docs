---
title: "Payment"
---

## Before Payment

This section explains the available payment options, how Stripe checkout links are created, what happens when users are redirected to Stripe, and how the system restores state when users return from the Stripe payment page.

### Available Payment Methods

The system provides two payment options for class registration:

**1. Bank Transfer (ACH):** This option is selected by default. The base price (no processing fees) is used. Stripe handles the payment, ensuring no bank details are stored by us.

**2. Credit Card:** If selected, a processing fee `(amount + 0.3 / 0.971)` is applied. Standard credit/debit card payment via Stripe.

### Payment Option Selection

Payment options are displayed using a tab-based interface, where users can switch between **Bank Transfer** and **Credit Card**. The selected payment option determines which Stripe checkout URL is generated and updates pricing (in the order details) dynamically.

<Note>
  Can we make a note of where (and briefly how) the dynamic pricing updates is handled?
</Note>

### Dynamic Pricing Updates

**How Dynamic Pricing Works**

Dynamic pricing updates are handled entirely on the **frontend**, without additional API calls. Pricing changes are driven by user interaction with payment method tabs and program selections.

**Trigger Points**

- **Payment Method Tab Click**
  - Elements: `.payment-cards-tab-link`
  - Switching between **Bank Transfer (ACH)** and **Credit Card**
- **Program / Brief Selection Changes**
  - Supplementary programs or briefs
  - Handled via `updateAmount()` (around line ~1765)

**Initialization**

- `updatePriceForCardPayment()` is called during **class initialization**
- This sets up all required event listeners for payment method switching
- Ensures correct prices are displayed on initial page load

**Payment Method Logic**

**Credit Card (Tab 2)**

When the credit card payment option is selected:

- Applies Stripe card processing fee using the formula:

```
(amount + 0.30) / 0.971
```

- Updates all relevant price displays:
  - Core product deposit\
    `[data-stripe='totalDepositPrice']`
  - Add-on program prices\
    `[data-stripe='addon-price']`
  - Add-on deposit prices\
    `[data-stripe='addon-deposit-price']`
  - Brief prices\
    `[data-stripe='brief-price']`
  - Gray summary price display\
    `.current-price-gray`

**Bank Transfer (ACH) – Tab 1**

When bank transfer is selected:

- Displays **base prices only**
- No card processing fee applied
- Prices already reflect the **3% discount**
- All price elements are reset to their original values

### Program / Brief Selection Flow

- When programs or briefs are selected/deselected:
  - `updateAmount()` recalculates totals
  - Triggers the active payment tab click
  - Ensures pricing updates reflect the current payment method (ACH vs Card)

---

### When Payment Options Are Displayed

Payment options appear when:

- A class time slot is selected
- The class has available seats (not waitlisted)
- The user account type is not `student`
- For pre-registrants, payment options appear only when supplementary programs or briefs are selected. Else, the registration is free.

## Checkout Link System

When the user proceeds to payment, the system creates a Stripe checkout session based on the selected payment method.

### Step 1: Proceed to Payment (Trigger Point)

User Action

- User clicks **“Pay Now”**

### Code Trigger

- **File:** `class_details_stripe_bundle.js`
- A click listener invokes:

```
initializeStripePayment()
```

This method is the **entry point** for all checkout logic.

### Step 2: Credit Application Check

- A modal prompts the user to apply available Bergen credits
- User selects **Apply** or **Skip**
- The selection is saved as `applyCredit` and included in checkout data

**TODO:** Need to give some specifics on where this happens in the code. What code gets triggered when the user proceeds to payment. Is there a clickListener? These details are important to add in the Technical Docs.

### Code Location

- **File:** `class_details_stripe_bundle.js`

Inside `initializeStripePayment()`:

```
const applyCredit =
  await Utils.waitForCreditApplicationChoice(this.webflowMemberId);
```

---

### Credit Modal Logic

**File:** `utils.js`\
**Method:** `waitForCreditApplicationChoice(webflowMemberId)`

Flow:

1. Fetch credit balance:

   ```
   GET getCreditBalance/{webflowMemberId}
   
   ```
2. If credit is `0` or invalid:
   - Returns `false`
   - Modal is skipped
3. If credit exists:
   - Displays `#bergen-credits-modal`
   - Populates values via `updateCreditData()`
4. User selects:
   - Apply → `true`
   - Skip → `false`

The resolved value is stored as:

```
applyCredit
```

### Step 3: Data Preparation

The following data is collected before generating the checkout link:

- Before generating the checkout URL, the system assembles:

  | Field            | Purpose                                                       |
  | :--------------- | :------------------------------------------------------------ |
  | checkoutId       | Existing checkout session ID (from localStorage, if resuming) |
  | label            | Human-readable description (Location \| Level \| Time)        |
  | classUniqueId    | Selected class identifier                                     |
  | location         | Selected location                                             |
  | memberId         | Webflow member ID                                             |
  | upsellProgramIds | Selected supplementary programs                               |
  | has_fee          | Indicates new student fee                                     |
  | source           | Always `cart_page`                                            |
  | amount           | Final amount (in cents)                                       |
  | applyCredit      | Credit usage flag                                             |
  | successUrl       | Redirect after payment success                                |
  | cancelUrl        | Redirect if payment is cancelled                              |

TODO: What is existing checkout session ID? there was no explanation of it earlier. I think we need to expand these tech docs to give a tech explantion of the prior steps (Log-in / Sign-Up, Student Profiles, Upsells, etc.)

**checkoutId**:  We generate a checkout ID when the user submits the student details form. We then update the checkout session after the user selects a class, bundle program, or briefs, based on the checkout ID.

There are additional fields for bundle purchases:

- `paymentId` – Bundle payment identifier
- `isBundleProgram` – Boolean flag
- `topics` – Selected brief topics (if applicable)

### Step 4: API Call and Response

Depending on the purchase type, one of two APIs is called:

#### Standard Checkout (`updateDataToCheckoutUrl`)

This API endpoint is used for normal class registration OR bundle(Pre-registration) purchases.

**TODO:** What do you mean "bundle purchases without supplementary programs?"

**supplementary means( with Bundle Program or Brief PDF ).**

#### Standard Checkout with Bundle program or briefs Checkout (`checkoutUrlForUpsellProgram`)

- This API endpoint is used for bundle purchases with supplementary programs or briefs
- **_We are using this API on the portal purchase as well_**

### Response

The API returns:

```
{
  "success": true,
  "cardUrl": "https://checkout.stripe.com/...",
  "achUrl": "https://checkout.stripe.com/..."
}
```

**TODO:** I think API Call & Response can be combined as one step(combined both)

### Step 5: Redirect to Stripe

**TODO:** Explain that these links are used by frontend as the href for payment method registration buttons.

### Frontend Behavior

- URLs are assigned as `href` values
- Based on selected payment method:
  - Credit Card → `cardUrl`
  - Bank Transfer → `achUrl`
  - 

Before redirecting:

- `backbuttonstate = "1"` is set
- Checkout data is saved to `localStorage`
- API response is cached for restoration

TODO: I think some explanation of why these steps are important or what they control will be good.

**Why this matters**

- Enables recovery from:
  - Browser back button
  - Stripe cancel action
  - Network interruptions

## Returning from Stripe

There are several return scenarios, each of which are detailed in the following:

### 1. Successful Payment

TODO: What are the conditions on which this triggers (via the API)?

User is directed to a confirmation screen

**Redirect URL Pattern**:

```
payment-confirmation?type=Academic&programName={label}&pType={paymentType}
```

TODO: It will be good to explain what these URL parameters explain, or link to a section that will do it.

**System Behavior**:

- Payment is confirmed
- Registration is completed

### 2. Cancelled Payment

TODO: What are the triggers for this?

**Redirect URL Pattern**:

```
?returnType=back
```

**System Behavior**:

- Checkout state is restored from localStorage
- All user selections and form data are reloaded
- User can resume checkout

---

### 3. Browser Back Button

TODO: What URL are they sent back to? Then, it seems like the Detection Logic triggers. If Detection Logic determines user is returning from Stripe, then the same restoration logic as caancelled payment is triggered.

**Detection Logic**:

- `backbuttonstate === "1"`
- `returnType=back` exists
- Checkout data exists and is valid

**Behavior**:

- Same restoration logic as cancelled payment
- User resumes from last completed step

---

## State Restoration Process

When restoring checkout state, the system:

1. Validates checkout data (member ID & timestamp)
2. Restores student information
3. Reloads selected location and class time
4. Restores selected payment method
5. Recalculates totals
6. Restores bundle and supplementary selections
7. Updates UI steps and validations

TODO: This section needs work, but we can return to it.

---

## Data Persistence

TODO: Briefly explain the purpose here. Or we fold it in to the above section (where this is actually used)

### LocalStorage Keys

- `checkOutData`
- `checkOutBasicData`

Includes:

- Student info
- Selected class
- Payment method
- Bundle selections
- Creation timestamp

## Post-Payment Flow (After Successful Checkout)

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

### 1. Core Logic Flow (High Level)

1. Stripe sends webhook → `stripePaymentListener`
2. Payment status is derived (`Complete`, `Processing`, `Failed`)
3. `updateClassPayment()` is invoked
4. System updates payment records
5. Enrollment, referrals, coupons, waitlist cleanup occur
6. Emails are triggered
7. User is redirected to success / confirmation page

### 2. `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates. This API acts as the single entry point for all post-payment processing.

### What this API does

- Validates the Stripe webhook signature
- Extracts the `payment_intent` and checkout metadata
- Loads the corresponding record from `stripe_checkout_customer`
- Normalizes Stripe event data into internal payment statuses:
  - **Complete** → Payment confirmed and funds captured
  - **Processing** → Bank transfer or async payment still pending
  - **Failed** → Payment failed or was canceled
- Routes the event to the appropriate handler:
  - `updateClassPayment()` for class purchases
- Ensures idempotency so repeated webhooks do not create duplicates

### Behavior by payment status

- **Complete**
  - Triggers full post-payment processing
  - Enrollment, referrals, credits, and emails are executed
- **Processing**
  - Stores payment as pending
  - Enrollment is deferred until final confirmation
- **Failed**
  - Cleans up partial payment records
  - Prevents enrollment or benefit application

### 3. `updateClassPayment()`

`updateClassPayment()` is the **core business orchestration layer** for class purchases.\
It executes **all database writes, enrollment logic, referral handling, and cleanup** associated with a payment.

### Responsibilities

- Determines whether the payment is new or already processed (idempotency)
- Handles logic based on payment status (`Complete`, `Processing`, `Failed`)
- Persists payment and checkout state
- Applies all side effects tied to a successful purchase

All sections below execute under this function unless explicitly skipped due to failure or pending status.

## 1.3 Database Writes & Updates

### A. `payment_details`

- **Insert (first successful payment)**:
  - payment_intent
  - amount
  - studentId
  - classId
  - memberId
  - device & UTM metadata
  - couponCode (if applied)
- **Update (subsequent webhook calls)**:
  - status
  - receipt_url

### B. `stripe_checkout_customer`

- Updated on every webhook event:
  - payment_intent
  - status (Complete / Processing / Failed)

### C. Failure Handling

- If payment **fails**:
  - Delete `payment_details`
  - Delete upsell payments
  - Mark checkout status as Failed

---

## 1.4 Referral & Coupon Processing

- If a coupon is used:
  - Referral marked as `Purchased`
  - Purchased date updated
- If no existing coupon for family:
  - New **referral coupon** is generated
  - Coupon created in Stripe
  - Coupon stored in `coupon_details`

---

## 1.5 Trial → Paid Conversion

- If parent previously attended a trial class:
  - `trial_class_details.status` updated to `Purchased`

---

## 1.6 Enrollment & Cleanup

- **Waitlist cleanup**:
  - Removes student from `waitlist_details` for the purchased class
- **Upsell Programs** (if any):
  - Inserted into `upsell_payment_details`
- **Topic Purchases** (if any):
  - Inserted into topic payment collection

---

## 1.7 Credit & Discounts

- If discount or credit is applied:
  - Credit balance is updated
  - Linked to yearId & sessionId

---

## 1.8 Emails Triggered

### Automated Emails

- **Admin Notification**
  - Sent on successful payment
  - Includes order & enrollment details
- **User Emails** (implicit via Stripe receipt)
  - Stripe receipt URL stored in DB

---

## 1.9 User Redirection After Payment

- **Card Payments**:
  - Redirected immediately to **Success / Thank You page**
- **Bank Transfer Payments**:
  - Redirected to **Processing / Pending Confirmation page**

Final confirmation happens asynchronously via Stripe webhook.

---

## 1.10 Key Characteristics

- Webhook-driven (idempotent by `payment_intent`)
- Safe for retries
- Handles partial & async payments
- Centralized post-payment orchestration

---

This flow ensures financial consistency, enrollment accuracy, referral tracking, and reliable user communication after every payment.