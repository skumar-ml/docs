---
title: "Payment"
---

## Before Payment

This section explains the available payment options, how Stripe checkout links are created, what happens when users are redirected to Stripe, and how the system restores state when users return from the Stripe payment page.

### Available Payment Methods

The system provides two payment options for class registration:

**1. Bank Transfer (ACH):** This option is selected by default. The base price (no processing fees) is used. Stripe handles the payment, ensuring no bank details are stored by us.

**2. Credit Card:** If selected, a processing fee `(amount + 0.3 / 0.971)` is applied. Standard credit/debit card payment via Stripe.

### Payment Option Selection

Payment options are displayed using a tab-based interface, where users can switch between **Bank Transfer** and **Credit Card**. The selected payment option determines which Stripe checkout URL is generated and updates pricing (in the order details) dynamically.

**Dynamic Pricing**

Dynamic pricing updates are handled entirely on the **frontend**, without additional API calls. We use `onClickListeners()` on  `.payment-cards-tab-link` UI elements. These event listeners are put in place by `updatePriceForCardPayment()` , which is called during **class initialization.**

When the **credit card** payment option is selected, we apply the Stripe card processing fee using the formula: `(amount + 0.30) / 0.971` .

When **bank transfer** is selected, price elements are reset to their original (base price) values.

When **upsells** are added, `updateAmount()` recalculates totals and triggers the active payment tab click to ensure pricing reflect the current payment method.

<Accordion title="The following price displays are updated">
  - Core product deposit: `[data-stripe='totalDepositPrice']`
  - Add-on program prices: `[data-stripe='addon-price']`
  - Add-on deposit prices: `[data-stripe='addon-deposit-price']`
  - Brief prices: `[data-stripe='brief-price']`
  - Gray summary price display: `.current-price-gray`
</Accordion>

### When Payment Options Are Displayed

Payment options appear when:

- A class time slot is selected
- The class has available seats (not waitlisted)
- The user account type is not `student`
- For pre-registrants, payment options appear only when supplementary programs or briefs are selected. Else, the registration is free.

## Checkout Link System

When the user proceeds to payment, the system creates a Stripe checkout session based on the selected payment method.

The User clicking **"Pay Now"**, triggers the `initializeStripePayment()` from the `class_details_stripe_bundle.js` file. This method is the **entry point** for all checkout logic.

### BDC Credit Check

**First, we check if the user has BDC Credits.** If they do, a modal prompts the user to apply available Bergen credits. The selection is saved as `applyCredit` and included in checkout data. This logic is handled by `waitForCreditApplicationChoice(webflowMemberId)` in `utils.js` .

<Accordion title="Logic for BDC Credits">
  1.  Credit balance is checked via `GET getCreditBalance/{webflowMemberId}`
  2. If credit is `0` or invalid → returns `false &` 

     modal is skipped
  3. If credit exists → displays `#bergen-credits-modal` and p

     opulates values via `updateCreditData()`
  4. User selects:
     - Apply → `true`
     - Skip → `false`

  The resolved value is stored as:` applyCredit`
</Accordion>

<Note>
  TODO: Eventually a different page to explain BDC Credit System
</Note>

### Data Preparation for the Checkout Link

The following data is collected before generating the checkout link:

| Field            | Purpose                                                       |
| :--------------- | :------------------------------------------------------------ |
| checkoutId       | Existing checkout session ID (from localStorage, if resuming) |
| label            | Human-readable description (Location \| Level \| Time)        |
| classUniqueId    | Selected class identifier                                     |
| location         | Selected location                                             |
| memberId         | Webflow member ID                                             |
| upsellProgramIds | Selected supplementary programs                               |
| has_fee          | Indicates new student fee                                     |
| source           | Always `cart_page`                                            |
| amount           | Final amount (in cents)                                       |
| applyCredit      | Credit usage flag                                             |
| successUrl       | Redirect after payment success                                |
| cancelUrl        | Redirect if payment is cancelled                              |

**checkoutId**:  We generate a checkout ID when the user submits the student details form. We then update the checkout session after the user selects a class, bundle program, or briefs, based on the checkout ID.

<Note>
  TODO: I think we need a separate section altogether for checkoutId (perhaps, at the top). We need to explain that checkoutId is the unique key for the specific checkout section. We need to explain when a new record in this collection is created (and the name of the collection).
</Note>

There are additional fields for bundle purchases:

- `paymentId` – Bundle payment identifier
- `isBundleProgram` – Boolean flag
- `topics` – Selected brief topics (if applicable)

### API Call and Response

Depending on the purchase type, one of two APIs is called:

#### Standard Checkout (`updateDataToCheckoutUrl`)

This API endpoint is used for normal class registration OR bundled (e.g., pre-registered) purchases.

#### Standard Checkout with any Upsell (`checkoutUrlForUpsellProgram`)

- This API endpoint is used for upsells with bundled semesters or briefs
- **_We are using this API on the portal purchase as well._**

Regardless of which API is used, the return signature is:

```
{
  "success": true,
  "cardUrl": "https://checkout.stripe.com/...",
  "achUrl": "https://checkout.stripe.com/..."
}
```

### Redirect to Stripe

Payment URLs are assigned as `href` values on the **Pay Now** buttons, redirecting users based on the selected method (Credit Card → `cardUrl`, Bank Transfer → `achUrl`). Before redirecting, the cart sets `backbuttonstate = "1"` and saves the current checkout data to `localStorage`. This enables checkout recovery in cases such as using the browser back button, cancelling on Stripe, or network interruptions.

<Note>
  TODO: It might be worth us explaining what checkout data gets saved to localStorage, but I'm not sure. Let's skip for now.
</Note>

## Returning from Stripe

There are several return scenarios, each of which are detailed in the following:

### 1. Successful Payment

During the checkout session creation, we provide Stripe the success URL and cancel URL. After a successful payment, it redirects to the success URL with `urlParam`: **payment-confirmation?type=Academic&programName=&pType=**

- **Type(Academic | Summer)**: We have the same payment confirmation for both summer and academic registration. The type indicates which registration the payment confirmation is from. Currently, we use this for tracking purposes and analytics.
- **programName**: Class or Program Name: This will be displayed on the payment confirmation page.
- **Type**: Payment mode(Card | Bank Transfer). We use this for tracking purposes and analytics.

At this point, the payment is confirmed and the registration is completed.

<Note>
  Can we explain **how** we are using the urlParams for tracking and analytics?
</Note>

### 2. Cancelled Payment

When the user clicks the **Back** button on the Stripe checkout page, Stripe redirects them to the **cancel URL** with the parameter `CART_PAGE_URL?returnType=back`. Using this parameter, the cart page detects a back-navigation scenario and restores the last selected class, time slot, and bundle programs so the user can continue checkout seamlessly.

### 3. Browser Back Button

If the user clicks the **browser's** back button on Stripe, they are redirected  to the original cart URL. On page load, the checkout page detects if **backbuttonstate === "1"** and if there's valid checkout data (in `localStorage`). Then, it restores the last selected class, time slot, and bundle programs so the user can continue checkout seamlessly.

<Note>
  **TODO:** do we set backbuttonstate = 0 if successful payment?
</Note>