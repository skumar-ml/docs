---
title: "Payment"
---

## Before Payment

This section explains the available payment options, how Stripe checkout links are created, what happens when users are redirected to Stripe, and how the system restores state when users return from the Stripe payment page.

### Available Payment Methods

The system provides two payment options for class registration:

**1. Bank Transfer (ACH):** This option is selected by default. The base price (no processing fees) is used. Stripe handles the payment, ensuring no bank details are stored by us.

**2. Credit Card:** If selected, a processing fee (amount + 0.3 / 0.971) is applied. Standard credit/debit card payment via Stripe

<Note>
  TODO: Why is it "approximately"???? Can we be exact? **Updated the exact calculation**
</Note>

### Payment Option Selection

Payment options are displayed using a tab-based interface, where users can switch between **Bank Transfer** and **Credit Card**. The selected payment option determines which Stripe checkout URL is generated and updates pricing (in the order details) dynamically.

<Note>
  Can we make a note of where (and briefly how) the dynamic pricing updates is handled?
</Note>

### When Payment Options Are Displayed

Payment options appear when:

- A class time slot is selected
- The class has available seats (not waitlisted)
- The user account type is not `student`
- For pre-registrants, payment options appear only when supplementary programs or briefs are selected. Else, the registration is free.

## Checkout Link System

When the user proceeds to payment, the system creates a Stripe checkout session based on the selected payment method.

### Step 1: Credit Application Check

- A modal prompts the user to apply available Bergen credits
- User selects **Apply** or **Skip**
- The selection is saved as `applyCredit` and included in checkout data

**TODO:** Need to give some specifics on where this happens in the code. What code gets triggered when the user proceeds to payment. Is there a clickListener? These details are important to add in the Technical Docs.

### Step 2: Data Preparation

The following data is collected before generating the checkout link:

- `checkoutId` – Existing checkout session ID (from localStorage).
- `label` – Class description (Location | Level | Time)
- `classUniqueId` – Selected class identifier
- `location` – Selected location
- `memberId` – Webflow member ID
- `upsellProgramIds` – Selected supplementary program IDs
- `has_fee` – Indicates if new student fee applies
- `source` – Always set to `cart_page`
- `amount` – Final amount in cents
- `applyCredit` – Credit usage flag
- `successUrl` – Redirect URL after successful payment
- `cancelUrl` – Redirect URL if payment is cancelled

TODO: What is existing checkout session ID? there was no explanation of it earlier. I think we need to expand these tech docs to give a tech explantion of the prior steps (Log-in / Sign-Up, Student Profiles, Upsells, etc.)

There are additional fields for bundle purchases:

- `paymentId` – Bundle payment identifier
- `isBundleProgram` – Boolean flag
- `topics` – Selected brief topics (if applicable)

### Step 3: API Call

Depending on the purchase type, one of two APIs is called:

#### Standard Checkout (`updateDataToCheckoutUrl`)

This API endpoint is used for single class registration OR bundle purchases without supplementary programs.

**TODO:** What do you mean "bundle purchases without supplementary programs?"

#### Supplementary Checkout (`checkoutUrlForUpsellProgram`)

This API endpoint is used for bundle purchases with supplementary programs or briefs

### Step 4: API Response

The API returns:

```
{
  "success": true,
  "cardUrl": "https://checkout.stripe.com/...",
  "achUrl": "https://checkout.stripe.com/..."
}
```

**TODO:** I think API Call & Response can be combined as one step

### Step 5: Redirect to Stripe

**TODO:** Explain that these links are used by frontend as the href for payment method registration buttons.

**Credit Card** redirects to`cardUrl` and **Bank Transfer** redirect to `achUrl`. Before redirecting, we programatically do the following:

- `backbuttonstate` is set to `"1"`
- Checkout data is saved to `localStorage`
- API response is stored for restoration

TODO: I think some explanation of why these steps are important or what they control will be good.

## Returning from Stripe

There are several return scenarios, each of which are detailed in the following:

### 1. Successful Payment

TODO: What are the conditions on which this triggers (via the API)?

User is directed to a confirmation screen

**Redirect URL Pattern**:

```
payment-confirmation?type=Academic&programName={label}&pType={paymentType}
```

TODO: It will be good to explain what these URL parameters explain, or link to a section that will do it.

**System Behavior**:

- Payment is confirmed
- Registration is completed

### 2. Cancelled Payment

TODO: What are the triggers for this?

**Redirect URL Pattern**:

```
?returnType=back
```

**System Behavior**:

- Checkout state is restored from localStorage
- All user selections and form data are reloaded
- User can resume checkout

---

### 3. Browser Back Button

TODO: What URL are they sent back to? Then, it seems like the Detection Logic triggers. If Detection Logic determines user is returning from Stripe, then the same restoration logic as caancelled payment is triggered.

**Detection Logic**:

- `backbuttonstate === "1"`
- `returnType=back` exists
- Checkout data exists and is valid

**Behavior**:

- Same restoration logic as cancelled payment
- User resumes from last completed step

---

## State Restoration Process

When restoring checkout state, the system:

1. Validates checkout data (member ID & timestamp)
2. Restores student information
3. Reloads selected location and class time
4. Restores selected payment method
5. Recalculates totals
6. Restores bundle and supplementary selections
7. Updates UI steps and validations

TODO: This section needs work, but we can return to it.

---

## Data Persistence

TODO: Briefly explain the purpose here. Or we fold it in to the above section (where this is actually used)

### LocalStorage Keys

- `checkOutData`
- `checkOutBasicData`

Includes:

- Student info
- Selected class
- Payment method
- Bundle selections
- Creation timestamp

## Post-Payment Flow (After Successful Checkout)

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

### 1. Core Logic Flow (High Level)

1. Stripe sends webhook → `stripePaymentListener`
2. Payment status is derived (`Complete`, `Processing`, `Failed`)
3. `updateClassPayment()` is invoked
4. System updates payment records
5. Enrollment, referrals, coupons, waitlist cleanup occur
6. Emails are triggered
7. User is redirected to success / confirmation page

### 2. `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates. This API acts as the single entry point for all post-payment processing.

TODO: Describes what this API does (e.g., how it derives the payment status), and what happens for each payment status.

### 3. `updateClassPayment()`

TODO: Explain what all does. Write this in a way that maintains the logic. I believe all the below content can fit underneath here.

---

## 1.3 Database Writes & Updates

### A. `payment_details`

- **Insert (first successful payment)**:
  - payment_intent
  - amount
  - studentId
  - classId
  - memberId
  - device & UTM metadata
  - couponCode (if applied)
- **Update (subsequent webhook calls)**:
  - status
  - receipt_url

### B. `stripe_checkout_customer`

- Updated on every webhook event:
  - payment_intent
  - status (Complete / Processing / Failed)

### C. Failure Handling

- If payment **fails**:
  - Delete `payment_details`
  - Delete upsell payments
  - Mark checkout status as Failed

---

## 1.4 Referral & Coupon Processing

- If a coupon is used:
  - Referral marked as `Purchased`
  - Purchased date updated
- If no existing coupon for family:
  - New **referral coupon** is generated
  - Coupon created in Stripe
  - Coupon stored in `coupon_details`

---

## 1.5 Trial → Paid Conversion

- If parent previously attended a trial class:
  - `trial_class_details.status` updated to `Purchased`

---

## 1.6 Enrollment & Cleanup

- **Waitlist cleanup**:
  - Removes student from `waitlist_details` for the purchased class
- **Upsell Programs** (if any):
  - Inserted into `upsell_payment_details`
- **Topic Purchases** (if any):
  - Inserted into topic payment collection

---

## 1.7 Credit & Discounts

- If discount or credit is applied:
  - Credit balance is updated
  - Linked to yearId & sessionId

---

## 1.8 Emails Triggered

### Automated Emails

- **Admin Notification**
  - Sent on successful payment
  - Includes order & enrollment details
- **User Emails** (implicit via Stripe receipt)
  - Stripe receipt URL stored in DB

---

## 1.9 User Redirection After Payment

- **Card Payments**:
  - Redirected immediately to **Success / Thank You page**
- **Bank Transfer Payments**:
  - Redirected to **Processing / Pending Confirmation page**

Final confirmation happens asynchronously via Stripe webhook.

---

## 1.10 Key Characteristics

- Webhook-driven (idempotent by `payment_intent`)
- Safe for retries
- Handles partial & async payments
- Centralized post-payment orchestration

---

This flow ensures financial consistency, enrollment accuracy, referral tracking, and reliable user communication after every payment.