---
title: "Payment"
---

## Before Payment

This section explains the available payment options, how Stripe checkout links are created, what happens when users are redirected to Stripe, and how the system restores state when users return from the Stripe payment page.

### Available Payment Methods

The system provides two payment options for class registration:

**1. Bank Transfer (ACH):** This option is selected by default. The base price (no processing fees) is used. Stripe handles the payment, ensuring no bank details are stored by us.

**2. Credit Card:** If selected, a processing fee `(amount + 0.3 / 0.971)` is applied. Standard credit/debit card payment via Stripe.

### Payment Option Selection

Payment options are displayed using a tab-based interface, where users can switch between **Bank Transfer** and **Credit Card**. The selected payment option determines which Stripe checkout URL is generated and updates pricing (in the order details) dynamically.

**Dynamic Pricing**

Dynamic pricing updates are handled entirely on the **frontend**, without additional API calls. We use `onClickListeners()` on  `.payment-cards-tab-link` UI elements. These event listeners are put in place by `updatePriceForCardPayment()` , which is called during **class initialization.**

When the **credit card** payment option is selected, we apply the Stripe card processing fee using the formula: `(amount + 0.30) / 0.971` .

When **bank transfer** is selected, price elements are reset to their original (base price) values.

When **upsells** are added, `updateAmount()` recalculates totals and triggers the active payment tab click to ensure pricing reflect the current payment method.

<Accordion title="The following price displays are updated">
  - Core product deposit: `[data-stripe='totalDepositPrice']`
  - Add-on program prices: `[data-stripe='addon-price']`
  - Add-on deposit prices: `[data-stripe='addon-deposit-price']`
  - Brief prices: `[data-stripe='brief-price']`
  - Gray summary price display: `.current-price-gray`
</Accordion>

### When Payment Options Are Displayed

Payment options appear when:

- A class time slot is selected
- The class has available seats (not waitlisted)
- The user account type is not `student`
- For pre-registrants, payment options appear only when supplementary programs or briefs are selected. Else, the registration is free.

## Checkout Link System

When the user proceeds to payment, the system creates a Stripe checkout session based on the selected payment method.

The User clicking **"Pay Now"**, triggers the `initializeStripePayment()` from the `class_details_stripe_bundle.js` file. This method is the **entry point** for all checkout logic.

### BDC Credit Check

**First, we check if the user has BDC Credits.** If they do, a modal prompts the user to apply available Bergen credits. The selection is saved as `applyCredit` and included in checkout data. This logic is handled by `waitForCreditApplicationChoice(webflowMemberId)` in `utils.js` .

<Accordion title="Logic for BDC Credits">
  1.  Credit balance is checked via `GET getCreditBalance/{webflowMemberId}`
  2. If credit is `0` or invalid → returns `false &` 

     modal is skipped
  3. If credit exists → displays `#bergen-credits-modal` and p

     opulates values via `updateCreditData()`
  4. User selects:
     - Apply → `true`
     - Skip → `false`

  The resolved value is stored as:` applyCredit`
</Accordion>

<Note>
  TODO: Eventually a different page to explain BDC Credit System
</Note>

### Data Preparation for the Checkout Link

The following data is collected before generating the checkout link:

| Field            | Purpose                                                       |
| :--------------- | :------------------------------------------------------------ |
| checkoutId       | Existing checkout session ID (from localStorage, if resuming) |
| label            | Human-readable description (Location \| Level \| Time)        |
| classUniqueId    | Selected class identifier                                     |
| location         | Selected location                                             |
| memberId         | Webflow member ID                                             |
| upsellProgramIds | Selected supplementary programs                               |
| has_fee          | Indicates new student fee                                     |
| source           | Always `cart_page`                                            |
| amount           | Final amount (in cents)                                       |
| applyCredit      | Credit usage flag                                             |
| successUrl       | Redirect after payment success                                |
| cancelUrl        | Redirect if payment is cancelled                              |

**checkoutId**:  We generate a checkout ID when the user submits the student details form. We then update the checkout session after the user selects a class, bundle program, or briefs, based on the checkout ID. **TODO: This info would be great for student profiles. I vote that we create a new page that documents (technically) everything pre-payment:**

- **Log-in / Sign-up: How do we determine if user is or is not signed-up to skip this step? Redirect logic? Don't need details of Account Creation, since we've already handled that.**
- **Student Profiles: Where are these coming from. What happens when we create a new one. What if we edit an existing one. Add the checkoutId logic.**
- **Upsells: I think let's skip this for now. We likely need a different page devoted to upsells**

There are additional fields for bundle purchases:

- `paymentId` – Bundle payment identifier
- `isBundleProgram` – Boolean flag
- `topics` – Selected brief topics (if applicable)

### API Call and Response

Depending on the purchase type, one of two APIs is called:

#### Standard Checkout (`updateDataToCheckoutUrl`)

This API endpoint is used for normal class registration OR bundled (e.g., pre-registered) purchases.

#### Standard Checkout with an Upsell (Semester Bundle or Briefs)(`checkoutUrlForUpsellProgram`)

- This API endpoint is used for bundle purchases with supplementary programs or briefs
- **_We are using this API on the portal purchase as well_**

The APIs return:

```
{
  "success": true,
  "cardUrl": "https://checkout.stripe.com/...",
  "achUrl": "https://checkout.stripe.com/..."
}
```

### Redirect to Stripe

URLs are assigned as `href` values to the **"Pay Now"** buttons. The user is directed based on the selected payment method (Credit Card → `cardUrl`, Bank Transfer → `achUrl`)

Before redirecting:

- `backbuttonstate = "1"` is set
- Checkout data is saved to `localStorage`
- API response is cached for restoration

**Why this matters**

- Enables recovery from:
  - Browser back button
  - Stripe cancel action
  - Network interruptions

<Note>
  TODO: I'm not satisfied with this explanation of backbuttonstate and localStorage usage. We can revisit later on.

  1. 
</Note>

## Returning from Stripe

There are several return scenarios, each of which are detailed in the following:

### 1. Successful Payment

TODO: What are the conditions on which this triggers (via the API)?

<Note>
  During the checkout session creation, I provide the success URL and cancel URL using JavaScript. After a successful payment, it redirects to the success URL.
</Note>

User is directed to a confirmation screen

**Redirect URL Pattern**:

```
payment-confirmation?type=Academic&programName={label}&pType={paymentType}
```

TODO: It will be good to explain what these URL parameters explain, or link to a section that will do it.

<Note>
  1. Type(Academic | Summer): We have the same payment confirmation for both summer and academic registration. The type indicates which registration the payment confirmation is from. We use this for tracking purposes and analytics.
  2. programName: Class or Program Name: This will be displayed on the payment confirmation page.
  3. Type: Payment mode(Card | Bank Transfer). We use this for tracking purposes and analytics.
</Note>

**System Behavior**:

- Payment is confirmed
- Registration is completed

### 2. Cancelled Payment

TODO: What are the triggers for this?

<Note>
  During the checkout session creation, I provide the success URL and cancel URL using JavaScript. When the user clicks on the back button on the Stripe checkout page, it will redirect to the cancel url
</Note>

**Redirect URL Pattern**:

```
?returnType=back
```

**System Behavior**:

- Checkout state is restored from localStorage
- All user selections and form data are reloaded
- User can resume checkout

---

### 3. Browser Back Button

TODO: What URL are they sent back to? Then, it seems like the Detection Logic triggers. If Detection Logic determines user is returning from Stripe, then the same restoration logic as caancelled payment is triggered.

**Detection Logic**:

- `backbuttonstate === "1"`
- `returnType=back` exists
- Checkout data exists and is valid

**Behavior**:

- Same restoration logic as cancelled payment
- User resumes from last completed step

---

## State Restoration Process

When restoring checkout state, the system:

1. Validates checkout data (member ID & timestamp)
2. Restores student information
3. Reloads selected location and class time
4. Restores selected payment method
5. Recalculates totals
6. Restores bundle and briefs selections
7. Updates UI steps and validations

TODO: This section needs work, but we can return to it.

---

## Data Persistence

TODO: Briefly explain the purpose here. Or we fold it in to the above section (where this is actually used)

<Warning>
  We can remove it from here.

  1. checkOutData: Storing all the checkout data before redirecting to the Stripe checkout page. It is also used for the abandoned cart display.
  2. checkOutBasicData: Storing only student form data. It will help to restore student information on the page reload.
</Warning>

### LocalStorage Keys

- `checkOutData`
- `checkOutBasicData`

Includes:

- Student info
- Selected class
- Payment method
- Bundle selections
- Creation timestamp

## Post-Payment Flow (After Successful Checkout)

This section explains **everything that happens after a payment is made**, starting from Stripe webhook to DB writes, emails, and user redirection.

### 1. Core Logic Flow (High Level)

1. Stripe sends webhook → `stripePaymentListener`
2. Payment status is derived (`Complete`, `Processing`, `Failed`)
3. `updateClassPayment()` is invoked
4. System updates payment records
5. Enrollment, referrals, coupons, waitlist cleanup occur
6. Emails are triggered
7. User is redirected to success / confirmation page

### 2. `stripePaymentListener` (Stripe Webhook)

We have a single webhook (`stripePaymentListener`) that is triggered by Stripe events such as `payment_intent.succeeded`, `checkout.session.completed`, or async bank transfer updates. This API acts as the single entry point for all post-payment processing.

### What this API does

- Validates the Stripe webhook signature
- Extracts the `payment_intent` and checkout metadata
- Loads the corresponding record from `stripe_checkout_customer`
- Normalizes Stripe event data into internal payment statuses:
  - **Complete** → Payment confirmed and funds captured
  - **Processing** → Bank transfer or async payment still pending
  - **Failed** → Payment failed or was canceled
- Routes the event to the appropriate handler:
  - `updateClassPayment()` for class purchases
- Ensures idempotency so repeated webhooks do not create duplicates

### Behavior by payment status

- **Complete**
  - Triggers full post-payment processing
  - Enrollment, referrals, credits, and emails are executed
- **Processing**
  - Stores payment as pending
  - Enrollment is deferred until final confirmation
- **Failed**
  - Cleans up partial payment records
  - Prevents enrollment or benefit application

### 3. `updateClassPayment()`

`updateClassPayment()` is the **core business orchestration layer** for class purchases.\
It executes **all database writes, enrollment logic, referral handling, and cleanup** associated with a payment.

### Responsibilities

- Determines whether the payment is new or already processed (idempotency)
- Handles logic based on payment status (`Complete`, `Processing`, `Failed`)
- Persists payment and checkout state
- Applies all side effects tied to a successful purchase

All sections below execute under this function unless explicitly skipped due to failure or pending status.

## 1.3 Database Writes & Updates

### A. `payment_details`

- **Insert (first successful payment)**:
  - payment_intent
  - amount
  - studentId
  - classId
  - memberId
  - device & UTM metadata
  - couponCode (if applied)
- **Update (subsequent webhook calls)**:
  - status
  - receipt_url

### B. `stripe_checkout_customer`

- Updated on every webhook event:
  - payment_intent
  - status (Complete / Processing / Failed)

### C. Failure Handling

- If payment **fails**:
  - Delete `payment_details`
  - Delete upsell payments
  - Mark checkout status as Failed

---

## 1.4 Referral & Coupon Processing

- If a coupon is used:
  - Referral marked as `Purchased`
  - Purchased date updated
- If no existing coupon for family:
  - New **referral coupon** is generated
  - Coupon created in Stripe
  - Coupon stored in `coupon_details`

---

## 1.5 Trial → Paid Conversion

- If parent previously attended a trial class:
  - `trial_class_details.status` updated to `Purchased`

---

## 1.6 Enrollment & Cleanup

- **Waitlist cleanup**:
  - Removes student from `waitlist_details` for the purchased class
- **Upsell Programs** (if any):
  - Inserted into `upsell_payment_details`
- **Topic Purchases** (if any):
  - Inserted into topic payment collection

---

## 1.7 Credit & Discounts

- If discount or credit is applied:
  - Credit balance is updated
  - Linked to yearId & sessionId

---

## 1.8 Emails Triggered

### Automated Emails

- **Admin Notification**
  - Sent on successful payment
  - Includes order & enrollment details
- **User Emails** (implicit via Stripe receipt)
  - Stripe receipt URL stored in DB

---

## 1.9 User Redirection After Payment

- **Card Payments**:
  - Redirected immediately to **Success / Thank You page**
- **Bank Transfer Payments**:
  - Redirected to **Processing / Pending Confirmation page**

Final confirmation happens asynchronously via Stripe webhook.

---

## 1.10 Key Characteristics

- Webhook-driven (idempotent by `payment_intent`)
- Safe for retries
- Handles partial & async payments
- Centralized post-payment orchestration

---

This flow ensures financial consistency, enrollment accuracy, referral tracking, and reliable user communication after every payment.