---
title: "Pre-Payment"
---

## 1. Login / Signup / Cart Redirection

### Authentication

Memberstack detects whether a user is logged in by checking for an active member session on page load. Before authentication, login/signup sections (signup form, login modal) are shown, while post-login sections (cart and multi-step checkout process) are hidden using `data-ms-content="!members"` and `data-ms-content="members"`.

For custom logic, the same session is read from `localStorage` (`memberstack`) and the `webflowMemberId` is used to confirm authentication.

```
var memberstackData = JSON.parse(memberstack);
var webflowMemberId = memberstackData.information.id;
if(webflowMemberId != null) {// User Logged In or Sign-up}
else{// User not Logged In or Sign-up}
```

### Cart Redirection Logic

When a user visits a cart page, we save the cart URL in `localStorage.redirect_url`. After logging-in or signing-up, Memberstack (through a pre-set default) redirects users to `/portal/home`.

There is on-page JS that checks if `redirect_url` exists. If it does, the URL is deleted, and saved in a temp variable, which is used to redirect the user back to the cart page they were originally on.

## 2. Student Profile

**Existing Students:** To get existing students, we call `getAllPreviousStudents/{memberId}/all`, where we use the `memberId` of the logged-in user. Our frontend logic via `class_details_stripe_bundle.js`, where the `updateOldStudentList()`  renders the saved students in a dropdown. Selecting a student from this dropdown auto-fills the Student Details Form.

**Student Details Form:**

- Fields: First Name, Last Name, Email, Grade, School, Gender, Previous Student

When the user clicks the **Next** button, our onClickListener calls `storeBasicData()` to add the form data to `localStorage` (which is used to pre-fill the Student Details Form on future visits).

Then, our onClickListener calls `AddStudentData()`, which validates and submits student details to the `checkoutUrlForClasses` API. The API initializes a checkout session by creating or linking the student profile and returns a unique `checkoutId`. This `checkoutId` controls the entire checkout flow, including bundle selection, class selection, briefs, seat validation, and payment.

<Info>
  TODO: Note, we'll need to explain checkoutId in more detail on the Payment page. Not critical to do now.
</Info>

## 3. Optional Bundle Program

### Data & Rendering

After a member logs in, the `classDetailsStripe`**class**  (defined in `class_details_stripe_bundle.js`) is initialised on page load. (from **\<TODO: What is classDetailsStripe? I think it's the first time it's mentioned \>)**. This class triggers the `getUpsellProgramV2` API, which fetches upsell programs for **both** current session and summer session. The frontend filters out `sessionId !== 2`, where `sessionId = 2` represents the summer session, and the filtered upsells are then rendered in both the **banner CTA** and ****`bundle selection modal using class_details_stripe_bundle.js file<TODO: by which JS file?>`**** .

### Logic Bundle Modal Open and Skip

The modal opens when the user clicks **Next** (on the Student Details Form), unless it is skipped. It is skipped if at least **two checkboxes (the Current Session Program — selected by default — and one Bundle Program)** are already selected, or if the modal was dismissed within the **last 1 hour**, tracked via cookies.

**Updated the text**

<Warning>
  **TODO: This logic is pretty hacky. We need to be more algorithmic than "if more than 2 bundles are already selected". This is future work**
</Warning>

![Image](/images/image-4.png)

### Selection Logic

Selecting an upsell program adds the program to `$selectedProgram`, a frontend state array that stores all bundle programs currently selected by the user for the active checkout session. We keep track of upsell state (selected or not) via their `programDetailId`, which is used to control the UI state in various locations (banner vs. modal). On each selection change, the checkout pricing logic is triggered method **updateAmount()** **\<TODO: what function is this?\>**, recalculating the total amount and updating the cart UI based on the programs stored in `$selectedProgram`.

<Note>
  TODO: For future, I think we'll need a little more detail on Upsell, and I think we should probably break it out onto it's own page. \
  \
  Specifically, how do we update the core program pricing when bundle is selected? How do we store in payment_details?
</Note>

## 4. Class Selection & Payment

On page load (after member is logged in), the `getClassDetailByMemberIdAndLevelId` API, based on the selected `levelId`, gets class data, which populates the location options. Clicking a location shows the class time slot options in the format `{Day} {StartTime} - {EndTime}`.

This API also returns the total available spots (`numberOfSpot`) for the class, and the remaining spots (`leftSpot`), which are calculated by subtracting the total number of registrations for the class from `numberOfSpot` (as well as some logic around waitlists, discussed in **\<TODO: SK link to section here\>**

### Seat Availability (`getAlertMessage`)

The frontend calculates `leftSpotsPercentage = (leftSpots / numberOfSpots) * 100`. If **≤ 25% spots** are remaining, show a message “Hurry! Only X spots left”. If **no spots** are left, show that "Seats are full" and allow the user to sign-up for the waitlist (no payment allowed)

<Note>
  **TODO: In the future, we need a separate page/section discussing the waitlist system**
</Note>