---
title: "Pre-Payment"
---

## 1. Login / Signup / Cart Redirection

### Authentication

<Note>
  TODO: I don't care about any of this -- we've already covered it elsewhere. Can you explain HOW we know that the user is logged in or not? And how we use that to either hide or display this section..
</Note>

Memberstack detects whether a user is logged in by checking for an active member session on page load. UI sections are automatically shown or hidden using data-ms-content="members" (logged in) and data-ms-content="!members" (logged out). 

For custom logic, the same session is read from localStorage (memberstack) and the memberId is used to confirm authentication.

```
var memberstackData = JSON.parse(memberstack);
var webflowMemberId = memberstackData.information.id;
if(webflowMemberId != null) {  
  // User Logged In or Sign-up
}else{
  // User not Logged In or Sign-up
}
```

### Signup (Parent Account)

<Note>
  TODO: This can be deleted. Not useful, already covered in Members section.
</Note>

- URL: `https://www.bergendebate.com/sign-up`
- Flow:

  ```
  Webflow Form → MemberStack → Webhook → Webflow CMS + MongoDB
  
  ```

**Webhooks**

<Note>
  TODO: We don't need this section. Also, what is `updateWebflowMongoDB`? It was never mentioned in the Members \> Creating an Account section...
</Note>

- `createUserSignup`
  - Trigger: New MemberStack record
  - Actions:
    - Create Webflow CMS member (slug = memberId)
    - Update MemberStack with `webflowItemId`
    - Create MongoDB `members` record
- `updateWebflowMongoDB`
  - Trigger: MemberStack update
  - Syncs updates to Webflow CMS + MongoDB

### Cart Redirection Logic

When a user visits a cart page, we save the cart URL in `localStorage.redirect_url`. After logging-in or signing-up, Memberstack (through a pre-set default) redirects users to `/portal/home`.

There is some on-page JS that checks if `redirect_url` exists. If it does, the URL is deleted, and saved in a temp variable, which is used to redirect the user back to the cart page they were originally on.

## 2. Student Profile

**Existing Students:** To get existing students, we call `getAllPreviousStudents/{memberId}/all`, where we use the `memberId` of the logged-in user. Our frontend logic (via **\<TODO: Which JS file or function?\>**) renders the saved students in a dropdown. Selecting a student from this dropdown auto-fills the Student Details Form.

**Student Details Form:**

- Fields: First Name, Last Name, Email, Grade, School, Gender, Previous Student

When the user clicks the **Next** button, our onClickListener calls `storeBasicData()` to add the form data to `localStorage`  **(TODO: Why are we saving this data? Where does it get used? Is there a step we are missing here, where on load of the Student Profile, we check for localStorage and pre-fill student data??)**

Then, our onClickListener calls `AddStudentData()`, which calls the `checkoutUrlForClasses` API and returns the `checkoutId`.

****`TODO: Are there other things that AddStudentData is going, or is it just calling the API? Also, we need to briefly explain the logic of the API. Finally, what is checkoutId? What does it control. We need to explain in more detail what it does. I think the description below is inadequate.`****

- `checkoutId` links:
  - Class selection
  - Bundle program
  - Briefs

## 3. Optional Bundle Program

\*\*TODO: Can you explain when the \*\*`getUpsellProgramV2`\*\*API gets triggered? \*\*

### Data & Rendering

**TODO: What frontend function is calling this or handling this...**

- API: `getUpsellProgramV2`
- Filters out `sessionId === 2` (current program) **\<TODO: is this hardcoded?\>**
- Renders:
  - Bundle modal
  - Banner CTA

### Modal Skip Logic (`checkSemesterBundleModalOpen`)

We skip showing the modal if more than 2 bundles are already selected, or if the modal was already closed within the last 1 hour (managed via cookies)

**TODO: Is this skip logic housed within frontend function that does "Data & Rendering"?**

<Warning>
  **TODO: This logic is pretty hacky. We need to be more algorithmic than "if more than 2 bundles are already selected"**
</Warning>

### Selection Logic

**TODO: How is selection logic handled? Is there an onClickListener?**

- Updates `$selectedProgram` **(TODO: What is selectedProgram? First time this is being referenced)**
- Syncs checkboxes by `programDetailId` **(TODO: I have no clue what this means. Give more details.)**
- UI feedback: `border-brown-red`
- Updates cart total dynamically **(TODO: How? What gets called?)**

### Core Program Handling (`updateCoreData`)

- Auto-adds core program if any bundle selected
- Core price set to **0** in bundle flow

**TODO: What are we calling as a core program??**

---

## 4. Class Selection & Payment

\*\*TODO: How does the \*\*`getClassDetailByMemberIdAndLevelId`**API get triggered?**

Based on the selected `levelId`, the API gets class data, which populates the location options. Clicking a location shows the class time slot options in the format `{Day} {StartTime} - {EndTime}`.

Attributes: `classId`, `levelName`, `numberOfSpots`, `leftSpots` **(TODO: This can be deleted)**

\*\*TODO: We need to descibe what \*\*`numberOfSpots`\*\*and \*\* `leftSpots`\*\*are, and (at a high level) how they are calculated by the API. \*\*

### Seat Availability (`getAlertMessage`)

The frontend calculates `leftSpotsPercentage = (leftSpots / numberOfSpots) * 100`. If \*\*≤ 25% spots \*\*are remaining, show a message “Hurry! Only X spots left”. If **no spots** are left show a message that "Seats are full" and allow the user to sign-up for the waitlist (no payment allowed)

<Note>
  **TODO: In the future, we need a seperate page/section discussing the waitlist system**
</Note>