---
title: "Web Checkout"
---

## Summer Overview Page

Most checkout journeys begin from the [summer overview page](https://www.bergendebate.com/classes-overview).

TODO: Explain how data from the semester overview page is populated via Webflow CMS. Explain importance of each field.

The **Summer Semester Overview page** displays a list of available summer programs.\
All program-level information on this page is **fully driven by Webflow CMS collections**, allowing the content team to manage programs without code changes.

Each row on the page represents **one Webflow collection item (one summer program)**.

![Image](/images/image-2.png)

## Webflow CMS as the Data Source

All summer programs are stored as **collection items in Webflow CMS**.\
Each collection item contains structured fields that control what appears on the overview page and what expands when a program row is clicked.

## Information Displayed on the Page

### 1. Program Name

**Examples:**

- Model UN + Young Entrepreneurship
- Model UN
- Young Entrepreneurship
- Intro to Debate
- PF Labs
- August Intensive

**Source:** Webflow CMS – Program Name field

**Why It’s Important:**

- Acts as the primary identifier for the program
- Used as the main clickable row title
- Helps parents quickly compare offerings

### 2. Program Time

**Examples:**

- 9:30 AM – 3:15 PM
- 9:30 AM – 12:00 PM

**Source:** Webflow CMS – Time field

**Why It’s Important:**

- Helps parents assess daily schedule compatibility
- Displayed directly in the overview row for quick scanning
- Reduces clicks by showing key timing upfront

### 3. Suggested Grades

**Examples:**

- 6th–8th
- 7th–9th

**Source:** Webflow CMS – Suggested Grades field

**Why It’s Important:**

- Ensures parents understand age and grade suitability
- Prevents incorrect registrations
- Helps families quickly filter relevant programs

### 4. Register Now Button

**Behavior:**

- Redirects users directly to the **cart / checkout page**

**Source:** Webflow CMS – Register Link field

**Why It’s Important:**

- Primary conversion action
- Allows marketing and admin teams to control registration links
- Can be updated per program without developer involvement

### 5. Learn More Link

**Behavior:**

- Redirects users to the **detailed program page**

**Source:** Webflow CMS – Program Detail Page link

**Why It’s Important:**

- Provides deeper program descriptions
- Supports parents who want more information before registering
- Keeps the overview page clean and uncluttered

## Expanded Program Information (On Row Click)

When a user clicks on a program row, **additional details expand**, all sourced from the same Webflow collection item.

### 6. Location

**Examples:**

- Fort Lee
- Glen Rock
- Livingston

**Source:** Webflow CMS – Location field (multi-value or reference)

**Why It’s Important:**

- Helps families choose based on proximity
- Supports programs offered in multiple locations
- Displayed only on expansion to keep the overview concise

### 7. Session Information

**Examples:**

- Session 2: 7/6 – 7/17
- Session 3: 7/21 – 8/1

**Source:** Webflow CMS – Session field(s)

**Why It’s Important:**

- Clearly communicates program duration
- Allows multiple sessions under one program
- Reduces confusion about start and end dates

## Cart Page

<Steps>
  <Step title="New Step">
    TODO: Explain steps of checkout here. Keep this non-technical
  </Step>
</Steps>

## Overview

The Summer Checkout flow includes:

1. Entering student details
2. Selecting a session and location
3. Optionally choosing future bundle programs
4. Completing payment

Each step must be completed before moving forward.

---

## Step 1: Student Details

This is the first step of the checkout process.

### Information Collected

The user is asked to provide:

- **Student First Name**
- **Student Last Name**
- **Email Address**
- **Student Grade**
- **Student School Name**
- **Student Gender**
- **Has your child participated in a BDC class before?** (Yes / No)

### What Happens Next

- The information is saved
- Clicking **Next** moves the user to the **Select Session** step

---

## Step 2: Select Session

In this step, the user chooses when and where the summer program will take place.

### Session Selection

- The user selects a **session**
  - Example: Session 1, Session 2, etc.

### Location Selection

- Based on the selected session, available **locations** are displayed
- The user selects **one location**

### What Happens Next

- Clicking **Next** opens the **Bundle Program Popup**

---

## Step 3: Bundle Program Popup (Optional)

This step allows families to add **future programs** as a discounted bundle.

### What the User Sees

- A popup listing available future bundle programs
- The option to:
  - Select one or more bundle programs
  - Skip by clicking **No Thanks**

### Behavior

- Bundle selection is optional
- Users can select multiple programs
- Closing the popup moves the user to the **Payment Screen**

---

## Step 4: Payment Screen

This is the final step where the user reviews details and completes payment.

---

### Payment Options

Once the checkout details are confirmed, payment options appear.

#### Available Payment Methods

- **Bank Transfer**
- **Credit Card**

### Payment Flow

- User selects a payment method
- After selecting a payment option, the **Buy Now** button becomes available
- Clicking **Buy Now** redirects the user to the **Stripe Checkout page**

---

## Stripe Checkout

### On the Stripe Page

- User enters payment details securely
- Stripe processes the payment
- Payment information is not stored on the website

### After Successful Payment

- User is redirected to a **Success / Confirmation page**
- The student is successfully registered for the summer program

---

## Bundle Program Banner

On the payment screen, a **Bundle Program Banner** is visible.

### Purpose

- Shows any selected future bundle programs
- Allows users to:
  - Review selected bundle programs
  - Add or update bundle selections directly from the banner

---

## Order Details

This section shows a full summary of the registration.

### Information Displayed

- Selected summer program and session
- Selected location
- Selected bundle future programs
- Selected briefs (if applicable)
- Price breakdown and total amount

### Why This Matters

- Helps users review their selections
- Ensures transparency before payment
- Reduces checkout errors

---

## Summer Checkout Summary

1. Enter student information
2. Select session and location
3. Optionally choose future bundle programs
4. Select payment method
5. Complete payment on Stripe
6. View confirmation page

TODO: Give a technical explanation of how checkout page works (before payment). Explain things that are materially different than how we do them on the semester checkout end. Else, just reference the APIs/codes that accomplish the functionality.

Things to explain are the sign-up / log-in redirect, how session & locations are added in, the number of spots calculation, the code & triggers for code for PF Labs, how Model UN & Young Entreneurship are combined.

<Warning>
  TODO: Need to add the following(Future)

  1. Saved student profiles (similar to semester)
  2. Order session display numerically. This can be done now itself
  3. **View student details in the payment screen**
  4. **Brief upsell**
</Warning>

## Checkout System

TODO: For all of these, reference logics that are similar to semester checkout. Specifically highlight logic that is unique to summer.

### Before Payment

TODO: Explain the payment options, how the checkout links are created, what happens when user is directed to Stripe, what happens if user returns back from Stripe page

The summer checkout supports **two payment methods**, which are shown on the payment step after all required selections are completed.

### 1. ACH Payment (Bank Transfer)

- Paid directly from a bank account
- Uses Stripe’s secure ACH payment flow
- No additional processing fees are applied
- Displays the base program price
- Redirects the user to a Stripe-hosted checkout page to complete payment

ACH payments are often preferred when users want to avoid card processing fees.

---

### 2. Credit / Debit Card Payment

- Paid using a credit or debit card
- Processed securely through Stripe
- Includes a standard card processing fee
- Displays a slightly higher total price due to the fee
- Redirects the user to a Stripe-hosted checkout page for card entry

---

## When Payment Options Appear

Payment options become available only after the user has:

1. Completed the student information form
2. Selected a summer session
3. Selected a location
4. Reached the payment step of the checkout flow

Once these steps are completed, both payment buttons are displayed and the user may choose either option.

---

## How Checkout Links Are Created

Checkout links are created and updated in stages as the user progresses through the checkout flow. This ensures Stripe always has the most up-to-date information.

---

### Step 1: Initial Checkout Creation

**When this happens**\
After the user completes the student information form and clicks **Next**.

**What happens**

- Student details are collected (name, email, grade, school, gender, previous participation)
- Program and pricing information is prepared
- A checkout session is created in Stripe
- Two Stripe checkout links are generated:
  - One for ACH payment
  - One for card payment

This initial checkout session is saved so it can be updated later as the user makes additional selections.

---

### Step 2: Updating Session and Location

**When this happens**\
After the user selects a summer session and location, then clicks **Next**.

**What happens**

- The existing checkout session is updated with:
  - Selected session
  - Selected location
- No new checkout is created — the same session is enhanced with more details

This ensures Stripe reflects the exact program and location the user selected.

---

### Step 3: Final Update Before Redirecting to Stripe

**When this happens**\
When the user clicks either the **ACH** or **Card** payment button.

**What happens**

- Any selected bundle or add-on programs are attached
- Final success and return URLs are confirmed
- The checkout session is finalized
- The user is redirected to Stripe using the selected payment link

At this point, the checkout is fully prepared and ready for payment.

---

## What Happens on the Stripe Checkout Page

Once redirected to Stripe:

1. The user reviews the order summary
2. The user enters payment details:
   - Bank details for ACH
   - Card details for card payments
3. Stripe securely processes the payment
4. Stripe manages the checkout session and transaction

The user may either:

- Complete the payment
- Cancel and return to the site
- Leave the page and return later (session remains active for a period)

---

## What Happens When the User Returns From Stripe

There are multiple return scenarios that the system handles automatically.

---

### 1. Successful Payment

**What happens**

- User is redirected to the payment confirmation page
- The payment is recorded successfully
- The summer program registration is confirmed
- The checkout flow is completed

---

### 2. Cancelled Payment or Manual Return

**What happens**

- User is redirected back to the checkout page
- The system detects the return
- All previously entered information is restored:
  - Student details
  - Selected session
  - Selected location
  - Selected bundle programs
- Payment options are shown again so the user can continue

The user does not need to start over.

---

### 3. Browser Back Button Return

**What happens**

- The system recognizes that the user came back from Stripe
- The checkout state is restored in the same way as a cancelled payment
- The user can resume from where they left off

---

## How Checkout State Is Restored

When a user returns from Stripe, the system:

1. Confirms that a valid checkout session exists
2. Restores student information
3. Restores selected session and location
4. Restores any selected bundle programs
5. Displays the payment step again
6. Updates the order summary with correct pricing

If no valid checkout data is found, the user starts a fresh checkout.

---

## Payment Flow Summary

1. User fills out student details
2. Checkout session is created
3. User selects session and location
4. Checkout session is updated
5. User selects payment method
6. User is redirected to Stripe
7. Payment is completed or cancelled
8. User is redirected back with state restored or confirmation shown

### After Payment

TODO: Explain everything that happens after payment. What APIs get triggered, what writes happen in the DB, where user gets directed after, any automated emails

## 1. API Triggered After Payment

### `stripePaymentListener` (Stripe Webhook)

**Triggered by:**

- Stripe events such as:
  - `checkout.session.completed`
  - `payment_intent.succeeded`
  - Async updates for **Bank Transfer**

**Responsibility:**

- Acts as the single orchestrator for all post-payment logic.
- Calls `updateSummerPayment()` with:
  - `stripeCheckout`
  - `status` (`Complete`, `Processing`, `Failed`)
  - `chargeObj`
  - `sessionId`

---

## 2. High-Level Logic Flow

1. Stripe confirms payment → webhook fires
2. `stripePaymentListener` is invoked
3. `updateSummerPayment()` executes
4. Payment record is inserted or updated
5. Inventory caps are updated
6. Referral & coupon logic runs
7. Emails are triggered
8. User is redirected based on payment type

---

## 3. Database Writes & Updates

### 3.1 `summer_payment_details`

**Insert (first successful payment):**

- payment_intent
- programId
- studentId
- memberId
- yearId
- summerSessionId
- locationId
- amount
- couponCode (if any)
- UTM source
- createdOn

**Update (subsequent webhook calls):**

- status
- receipt_url

**Delete (on Failed payment):**

- Existing `summer_payment_details` record is removed

---

### 3.2 `stripe_checkout_customer`

Updated on **every webhook event**:

- payment_intent
- status (`Complete`, `Processing`, `Failed`)

---

### 3.3 Inventory Management (`updateSummerInventoryCaps`)

- **On Failed payment**
  - Inventory is **released** (`eventType = add`)
- **On Complete / Processing**
  - Inventory is **consumed** (`eventType = minus`)

This ensures real-time seat availability for summer programs.

---

### 3.4 Referral & Coupon Handling

**If coupon was used:**

- Referral marked as `Purchased`
- `purchased_date` updated

**If no existing coupon for family:**

- New coupon code is generated
- Coupon created in **Stripe**
- Coupon stored in `coupon_details` with:
  - coupon_code
  - familyId
  - createdOn

---

### 3.5 `coupon_details`

- New coupon inserted **only once per family**
- Used for future referrals and discounts

---

### 3.6 Upsell Programs

If upsell programs were purchased:

- Records inserted via `addUpsellToPaymentDetails()`

---

### 3.7 Credit Balance Updates

If discount / credit was applied:

- `updateCreditBalance()` updates remaining credits
- Linked to:
  - yearId
  - currentSessionId

---

## 4. Automated Emails

### Admin Emails

- **Sent on:**
  - Card payment → `Complete`
  - Bank transfer → `Processing`
- Triggered via:

  ```
  sendSuccessEmailToAdmin(stripeCheckout, yearId)
  
  ```

### User Emails

- Stripe receipt generated automatically
- `receipt_url` stored in MongoDB

---

## 5. User Redirection After Payment

### Card Payments

- Redirected immediately to **Success / Thank You page**

### Bank Transfer Payments

- Redirected to **Processing / Pending Confirmation page**
- Final confirmation happens asynchronously via webhook

---

## 6. Failure Handling

If payment fails:

- `summer_payment_details` record deleted
- Inventory restored
- Checkout marked as Failed
- No enrollment or coupon generation occurs

---

## 7. Key Characteristics

- Fully **webhook-driven**
- **Idempotent** via `payment_intent`
- Supports **async bank transfers**
- Inventory-safe
- Referral-safe
- Retry-safe