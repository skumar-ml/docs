---
title: "Technical: Checkout Flow"
---

TODO: Give a technical explanation of how checkout page works (before payment). Explain things that are materially different than how we do them on the semester checkout end. Else, just reference the APIs/codes that accomplish the functionality.

Things to explain are the sign-up / log-in redirect, how session & locations are added in, the number of spots calculation, the code & triggers for code for PF Labs, how Model UN & Young Entreneurship are combined.

## Overview

The summer checkout flow follows a similar structure to the [semester checkout](/bdc/checkout-systems/semester/web-checkout/technical/pre-payment), with key differences in how sessions and locations are handled, and how certain programs are validated or combined. This document explains the technical implementation of the summer checkout system, highlighting unique aspects compared to semester checkout.

<Warning>
  TODO: Need to add the following(Future)

  1. Saved student profiles (similar to semester)
  2. Order session display numerically. This can be done now itself
  3. **View student details in the payment screen**
  4. **Brief upsell**
</Warning>

## Checkout System

TODO: For all of these, reference logics that are similar to semester checkout. Specifically highlight logic that is unique to summer.

The summer checkout system is implemented in `checkout_summer_bundle.js` and follows a multi-step flow similar to semester checkout. Key differences include session-based selection (instead of class time slots), location filtering based on available spots, and program-specific validation logic.

### Before Payment

TODO: Explain the payment options, how the checkout links are created, what happens when user is directed to Stripe, what happens if user returns back from Stripe page

The pre-payment flow consists of three main steps: student information collection, session and location selection, and optional bundle program selection. The implementation follows similar patterns to semester checkout but with summer-specific logic.

#### 1. Login / Signup / Cart Redirection

**Similar to Semester Checkout.**

Reference: See Semester Pre-Payment: Login / Signup / Cart Redirection for detailed implementation.

#### 2. Student Profile & Information Collection

**Similar to Semester Checkout:** Student information is collected via a form with fields: First Name, Last Name, Email, Grade, School, Gender, and Previous Student status.

**Key Difference:** Unlike semester checkout, summer checkout does **not** currently support saved student profiles. The system does not call `getAllPreviousStudents/{memberId}/all` to populate a dropdown of existing students. This is a planned future enhancement (see Warning section below).

When the user clicks **Next** on the student details form:

- `storeBasicData()` saves form data to `localStorage` (used to pre-fill on future visits)
- `initializeStripePayment()` is called, which triggers the `createNewProgramCheckoutUrls` API

**API Call:** `POST createNewProgramCheckoutUrls`

This API:

- Creates or retrieves a Stripe customer ID via `getCustomerId(email)`
- Creates or links the student profile via `checkAndCreateMembers()`
- Generates a unique `checkoutId` (16-character alphanumeric string)
- Creates two Stripe checkout sessions (one for card, one for ACH) via `createCheckoutSessionUrl()`
- Inserts two records into `stripe_checkout_customer` collection (one per payment type)
- Returns `checkoutId`, `cardUrl`, and `achUrl`

#### 3. Session & Location Selection

**Unique to Summer:** Unlike semester checkout where users select specific class time slots, summer checkout requires users to select a **summer session** and a **location**.

**Session Data Retrieval:**

On page load, the `CheckOutWebflow` class calls `getSummerSessionDetails/{memberId}/{programId}` API, which:

- Retrieves all summer program sessions for the given `programId` and current `yearId`
- For each session, fetches inventory data from `summer_inventory_caps` collection
- Returns session data with `leftSpot` and `numberOfSpots` for each location

**API:** `getSummerSessionDetails/{memberId}/{programId}`

**Number of Spots Calculation:**

The spots calculation is retrieved from the `summer_inventory_caps` MongoDB collection:

- `numberOfSpots`: Total available spots for a program at a location for a specific session
- `leftSpot`: Remaining spots (calculated as `numberOfSpots - registrations`)

The frontend filters sessions based on availability:

- Sessions are hidden if both Fort Lee (locationId: 2) and Glen Rock (locationId: 1) have `leftSpot == 0`
- Locations are only displayed if they have `leftSpot > 0` for the selected session

**Session & Location Update:**

After the user selects a session and location, clicking **Next** triggers `updateStudentDataInDB()`, which:

- Calls `updateDataToCheckoutUrl` API with `checkoutId`, `summerSessionId`, and `locationId`
- The API updates the existing `stripe_checkout_customer` records via `updateSummerSessionAndLocation()`
- No new checkout sessions are created; the existing sessions are updated with session and location metadata

**API:** `POST /camp/updateDataToCheckoutUrl`

#### 4. PF Labs Validation (Program ID: 101)

**Unique to Summer:** For PF Labs (programId: 101), an additional validation step occurs before allowing the user to proceed to session selection.

When the user clicks **Next** on the student details form:

- If `programId == '101'`, the frontend calls `validateUserForProgram` API
- The API validates the student's eligibility based on first name, last name, and memberId
- If validation fails (`eligible: false`), the user is shown an error message and cannot proceed
- If validation passes, the user continues to session selection

**API:** `POST /camp/validateUserForProgram`\
**Implementation:** `bcdc/checkout_summer_bundle.js` - `validateUserForProgram()` method

#### 5. Model UN & Young Entrepreneurship Combination (Program ID: 102)

**Unique to Summer:** Program ID 102 represents a combined program that includes both Model UN and Young Entrepreneurship.

**How It Works:**

In `getSummerSessionDetails` API, when `programId == 102`:

- The system queries `summer_inventory_caps` for **both** programId 103 and programId 104
- Inventory data from both programs is combined and returned together
- The frontend displays locations only if **both** programs have available spots at that location

**Implementation:** `getSummerSessionDetails.py`

```python
if int(programId) == 102:
    summerInventoryCaps = db.summer_inventory_caps.find({"programId": { "$in": [103,104] },"yearId": yearId})
else:
    summerInventoryCaps = db.summer_inventory_caps.find({"programId": int(programId), "yearId": yearId})
```

**Frontend Logic:** `checkout_summer_bundle.js` - `updateLocation()` method checks that both programs have available spots before displaying a location.

#### 6. Optional Bundle Program Selection

**Similar to Semester Checkout:** After session and location selection, users can optionally select bundle programs (future semester sessions) at a discounted rate.

The implementation follows the same pattern as semester checkout:

- `getUpsellProgramV2` API fetches upsell programs (filtered for `sessionId == 2` which represents summer)
- Bundle programs are displayed in a modal
- Selected programs are stored in `$selectedProgram` array
- Pricing is recalculated dynamically via `updateAmount()` method

**Reference:** See [Semester Pre-Payment: Optional Bundle Program](#) for detailed implementation.

## Payment

The summer checkout supports **two payment methods**, which are shown on the payment step after all required selections are completed. The payment flow is similar to semester checkout, with dynamic pricing updates handled on the frontend.

### 1. ACH Payment (Bank Transfer)

- Paid directly from a bank account
- Uses Stripe’s secure ACH payment flow
- No additional processing fees are applied
- Displays the base program price
- Redirects the user to a Stripe-hosted checkout page to complete payment

ACH payments are often preferred when users want to avoid card processing fees.

---

### 2. Credit / Debit Card Payment

- Paid using a credit or debit card
- Processed securely through Stripe
- Includes a standard card processing fee
- Displays a slightly higher total price due to the fee
- Redirects the user to a Stripe-hosted checkout page for card entry

---

## When Payment Options Appear

Payment options become available only after the user has:

1. Completed the student information form
2. Selected a summer session
3. Selected a location
4. Reached the payment step of the checkout flow

Once these steps are completed, both payment buttons are displayed and the user may choose either option.

---

## How Checkout Links Are Created

Checkout links are created and updated in stages as the user progresses through the checkout flow. This ensures Stripe always has the most up-to-date information.

**Similar to Semester Checkout:** The checkout link creation follows a similar pattern, but with key differences in when and how sessions are updated.

---

### Step 1: Initial Checkout Creation

**When this happens:** After the user completes the student information form and clicks **Next**.

**API Call:** `POST createNewProgramCheckoutUrls`

**What happens:**

- Student details are collected (name, email, grade, school, gender, previous participation)
- `checkAndCreateMembers()` creates or links the student profile
- A unique `checkoutId` is generated (16-character alphanumeric string)
- Two Stripe checkout sessions are created (one for card, one for ACH) via `createCheckoutSessionUrl()`
- Two records are inserted into `stripe_checkout_customer` collection:
  - One for `paymentType: "Card"`
  - One for `paymentType: "Bank Transfer"`
- Each record contains: `checkoutId`, `sessionId`, `customerId`, `checkoutUrl`, `studentId`, `memberId`, `programId`, `yearId`, `utmSource`
- Returns `checkoutId`, `cardUrl`, and `achUrl`

**Key Difference from Semester:** At this stage, `summerSessionId` and `locationId` are **not** included. They are added in Step 2.

**Implementation:** `createNewProgramCheckoutUrls.py` - `createCheckoutSessionUrl()` function

---

### Step 2: Updating Session and Location

**When this happens:** After the user selects a summer session and location, then clicks **Next**.

**API Call:** `POST updateDataToCheckoutUrl` with body: `{checkoutId, summerSessionId, locationId}`

**What happens:**

- The API calls `updateSummerSessionAndLocation(checkoutId, summerSessionId, locationId)`
- Updates **both** `stripe_checkout_customer` records (card and ACH) with:
  - `summerSessionId`
  - `locationId`
- **No new Stripe checkout sessions are created** — only metadata is updated in MongoDB
- The existing Stripe checkout URLs remain valid

**Key Difference from Semester:** Semester checkout updates the Stripe session with class details at this stage. Summer checkout only updates MongoDB metadata; Stripe sessions are updated later when payment is clicked.

**Implementation:** `bcdc_aws-main/payment-checkout-service/api/updateDataToCheckoutUrl.py` - `updateSummerSessionAndLocation()` function

**Frontend:** `bcdc/checkout_summer_bundle.js` - `updateStudentDataInDB()` method

---

### Step 3: Final Update Before Redirecting to Stripe

**When this happens:** When the user clicks either the **ACH** or **Card** payment button.

**API Call:** `POST updateDataToCheckoutUrl` with body: `{checkoutId, isSummerData: true, upsellProgramIds, successUrl, cancelUrl}`

**What happens:**

- The API calls `updateSummerCheckoutUrl()` which:
  - Sets `checkoutClicked: true` in `stripe_checkout_customer`
  - If `upsellProgramIds` are provided, calls `createCheckoutSessionUrlForSummer()` to:
    - Create new Stripe checkout sessions with bundle programs included
    - Update `stripe_checkout_customer` records with new `sessionId` and `checkoutUrl`
    - Include upsell program line items in the Stripe session
- Returns updated `cardUrl` and `achUrl`
- Frontend redirects user to the selected payment URL

**Key Difference from Semester:** Summer checkout creates new Stripe sessions at payment click time (if upsells are selected), whereas semester checkout may update existing sessions.

**Implementation:** `updateDataToCheckoutUrl.py` - `updateSummerCheckoutUrl()` and `createCheckoutSessionUrlForSummer()` functions

**Frontend:** `checkout_summer_bundle.js` - `updateClickEventInDB()` method

---

## After Payment

TODO: Explain everything that happens after payment. What APIs get triggered, what writes happen in the DB, where user gets directed after, any automated emails

## 1. API Triggered After Payment

### `stripePaymentListener` (Stripe Webhook)

**Triggered by:**

- Stripe events such as:
  - `checkout.session.completed`
  - `payment_intent.succeeded`
  - Async updates for **Bank Transfer**

**Responsibility:**

- Acts as the single orchestrator for all post-payment logic.
- Calls `updateSummerPayment()` with:
  - `stripeCheckout`
  - `status` (`Complete`, `Processing`, `Failed`)
  - `chargeObj`
  - `sessionId`

---

## 2. High-Level Logic Flow

1. Stripe confirms payment → webhook fires
2. `stripePaymentListener` is invoked
3. `updateSummerPayment()` executes
4. Payment record is inserted or updated
5. Inventory caps are updated
6. Referral & coupon logic runs
7. Emails are triggered
8. User is redirected based on payment type

---

## 3. Database Writes & Updates

### 3.1 `summer_payment_details`

**Insert (first successful payment):**

- payment_intent
- programId
- studentId
- memberId
- yearId
- summerSessionId
- locationId
- amount
- couponCode (if any)
- UTM source
- createdOn

**Update (subsequent webhook calls):**

- status
- receipt_url

**Delete (on Failed payment):**

- Existing `summer_payment_details` record is removed

---

### 3.2 `stripe_checkout_customer`

Updated on **every webhook event**:

- payment_intent
- status (`Complete`, `Processing`, `Failed`)

---

### 3.3 Inventory Management (`updateSummerInventoryCaps`)

- **On Failed payment**
  - Inventory is **released** (`eventType = add`)
- **On Complete / Processing**
  - Inventory is **consumed** (`eventType = minus`)

This ensures real-time seat availability for summer programs.

---

### 3.4 Referral & Coupon Handling

**If coupon was used:**

- Referral marked as `Purchased`
- `purchased_date` updated

**If no existing coupon for family:**

- New coupon code is generated
- Coupon created in **Stripe**
- Coupon stored in `coupon_details` with:
  - coupon_code
  - familyId
  - createdOn

---

### 3.5 `coupon_details`

- New coupon inserted **only once per family**
- Used for future referrals and discounts

---

### 3.6 Upsell Programs

If upsell programs were purchased:

- Records inserted via `addUpsellToPaymentDetails()`

---

### 3.7 Credit Balance Updates

If discount / credit was applied:

- `updateCreditBalance()` updates remaining credits
- Linked to:
  - yearId
  - currentSessionId

---

## 4. Automated Emails

### Admin Emails

- **Sent on:**
  - Card payment → `Complete`
  - Bank transfer → `Processing`
- Triggered via:

  ```
  sendSuccessEmailToAdmin(stripeCheckout, yearId)
  
  ```

### User Emails

- Stripe receipt generated automatically
- `receipt_url` stored in MongoDB

---

## 5. User Redirection After Payment

### Card Payments

- Redirected immediately to **Success / Thank You page**

### Bank Transfer Payments

- Redirected to **Processing / Pending Confirmation page**
- Final confirmation happens asynchronously via webhook

---

## 6. Failure Handling

If payment fails:

- `summer_payment_details` record deleted
- Inventory restored
- Checkout marked as Failed
- No enrollment or coupon generation occurs

---

## 7. Key Characteristics

- Fully **webhook-driven**
- **Idempotent** via `payment_intent`
- Supports **async bank transfers**
- Inventory-safe
- Referral-safe
- Retry-safe