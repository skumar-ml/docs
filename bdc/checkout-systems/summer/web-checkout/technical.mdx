---
title: "Technical: Checkout Flow"
---

TODO: Give a technical explanation of how checkout page works (before payment). Explain things that are materially different than how we do them on the semester checkout end. Else, just reference the APIs/codes that accomplish the functionality.

Things to explain are the sign-up / log-in redirect, how session & locations are added in, the number of spots calculation, the code & triggers for code for PF Labs, how Model UN & Young Entreneurship are combined.

The summer checkout system is implemented in `checkout_summer_bundle.js` and follows a multi-step flow similar to [semester checkout](/bdc/checkout-systems/semester/introduction). This documentation focuses on nuances specific to summer enrollment.

<Warning>
  TODO: Need to add the following(Future)

  1. Saved student profiles (similar to semester)
  2. Order session display numerically. This can be done now itself
  3. **View student details in the payment screen**
  4. **Brief upsell**
</Warning>

## Before Payment

The pre-payment flow consists of **three main steps**: (1) student information collection; (2) session and location selection; and (3) optional bundle program selection. The implementation follows similar patterns to semester checkout but with summer-specific logic.

The preliminary step is account log-in/sign-up. [The detailed implementation can be references in the semester checkout docs](/bdc/checkout-systems/semester/web-checkout/technical/pre-payment).

### 1. Student Profile & Information Collection

**Similar to Semester Checkout:** Student information is collected via a form with fields: First Name, Last Name, Email, Grade, School, Gender, and Previous Student status.

**Key Difference:** Unlike semester checkout, summer checkout **does** **not** currently support saved student profiles. The system does not call `getAllPreviousStudents/{memberId}/all` to populate a dropdown of existing students. _This is a planned future enhancement_.

When the user clicks **Next** on the student details form:

- `storeBasicData()` saves form data to `localStorage` (used to pre-fill on future visits)
- `initializeStripePayment()` is called, which triggers the `createNewProgramCheckoutUrls` API

**API Call:** `POST createNewProgramCheckoutUrls`

This API:

- Creates or retrieves a Stripe customer ID via `getCustomerId(email)`
- Creates or links the student profile via `checkAndCreateMembers()`
- Generates a unique `checkoutId` (16-character alphanumeric string)
- Creates two Stripe checkout sessions (one for card, one for ACH) via `createCheckoutSessionUrl()`
- Inserts two records into `stripe_checkout_customer` collection (one per payment type)
- Returns `checkoutId`, `cardUrl`, and `achUrl`

### 2. Session & Location Selection

**Unique to Summer:** Unlike semester checkout where users select specific class time slots, summer checkout requires users to select a **summer session** and a **location**.

**Session Data Retrieval:**

On page load, the `CheckOutWebflow` class calls `getSummerSessionDetails/{memberId}/{programId}` API, which:

- Retrieves all summer program sessions for the given `programId` and current `yearId`
- For each session, fetches inventory data from `summer_inventory_caps` collection
- Returns session data with `leftSpot` and `numberOfSpots` for each location

**API:** `getSummerSessionDetails/{memberId}/{programId}`

**Number of Spots Calculation:**

The spots calculation is retrieved from the `summer_inventory_caps` MongoDB collection:

- `numberOfSpots`: Total available spots for a program at a location for a specific session
- `leftSpot`: Remaining spots (calculated as `numberOfSpots - registrations`)

The frontend filters sessions based on availability:

- Sessions are hidden if both Fort Lee (locationId: 2) and Glen Rock (locationId: 1) have `leftSpot == 0` **\<TODO: Are we still doing this?? We have a Livingston location now..\>**
- Locations are only displayed if they have `leftSpot > 0` for the selected session

**Session & Location Update:**

After the user selects a session and location, clicking **Next** triggers `updateStudentDataInDB()`, which calls the `updateDataToCheckoutUrl` API with `checkoutId`, `summerSessionId`, and `locationId`. The API updates the existing `stripe_checkout_customer` records via `updateSummerSessionAndLocation()` to add the session and location metadata.

### (Optional) ProgramId Specific Nuances

We have specific logic to handle the case of PF Labs (which is restricted to specific users) and the MUN & YES full-day purchase (which represents a merged program of seperate classes of MUN and YES).

<AccordionGroup>
  <Accordion title="PF Labs ">
    **Unique to Summer:** For PF Labs (`programId`: 101), an additional validation step occurs before allowing the user to proceed to session selection.

    When the user clicks **Next** on the student details form:

    - If `programId == '101'`, the frontend calls `validateUserForProgram` API via (`checkout_summer_bundle.js`'s `validateUserForProgram()` method.
    - The API validates the student's eligibility based on first name, last name, and memberId
    - If validation fails (`eligible: false`), the user is informed that that they are ineligible for this program. The user can continue to registration if they have a bypass code.
    - If validation passes, the user continues to session selection
  </Accordion>
  <Accordion title="Model UN & Young Entrepreneurship Combination">
    **Unique to Summer:** `programId 102` represents a combined program that includes both Model UN and Young Entrepreneurship (which can also be enrolled in individually).

    **How It Works:**

    In `getSummerSessionDetails` API, when `programId == 102`:

    - The system queries `summer_inventory_caps` for **both** `programId` 103 and 104
    - Inventory data from both programs is combined and returned together
    - The frontend displays locations only if **both** programs have available spots at that location

    **Frontend Logic:** `checkout_summer_bundle.js` - `updateLocation()` method checks that both programs have available spots before displaying a location.
  </Accordion>
</AccordionGroup>

### 3. Optional Bundle Program Selection

**Similar to Semester Checkout:** After session and location selection, users can optionally select bundle programs (future semester sessions) at a discounted rate.

The implementation follows the same pattern as semester checkout, except that the `getUpsellProgramV2` API fetches summer upsell programs (filtered for `sessionId == 2` which represents summer). See the docs for the detailed implementation. \<TODO: SK link to correct docs\>.

## Payment

The summer checkout supports **two payment methods**, which are shown on the payment step after all required selections are completed. The payment flow is similar to semester checkout, with dynamic pricing updates handled on the frontend.

### 1. ACH Payment (Bank Transfer)

- Paid directly from a bank account
- Uses Stripe’s secure ACH payment flow
- No additional processing fees are applied
- Displays the base program price
- Redirects the user to a Stripe-hosted checkout page to complete payment

ACH payments are often preferred when users want to avoid card processing fees.

---

### 2. Credit / Debit Card Payment

- Paid using a credit or debit card
- Processed securely through Stripe
- Includes a standard card processing fee
- Displays a slightly higher total price due to the fee
- Redirects the user to a Stripe-hosted checkout page for card entry

---

## When Payment Options Appear

Payment options become available only after the user has:

1. Completed the student information form
2. Selected a summer session
3. Selected a location
4. Reached the payment step of the checkout flow

Once these steps are completed, both payment buttons are displayed and the user may choose either option.

---

## How Checkout Links Are Created

Checkout links are created and updated in stages as the user progresses through the checkout flow. This ensures Stripe always has the most up-to-date information.

**Similar to Semester Checkout:** The checkout link creation follows a similar pattern, but with key differences in when and how sessions are updated.

---

### Step 1: Initial Checkout Creation

**When this happens:** After the user completes the student information form and clicks **Next**.

**API Call:** `POST createNewProgramCheckoutUrls`

**What happens:**

- Student details are collected (name, email, grade, school, gender, previous participation)
- `checkAndCreateMembers()` creates or links the student profile
- A unique `checkoutId` is generated (16-character alphanumeric string)
- Two Stripe checkout sessions are created (one for card, one for ACH) via `createCheckoutSessionUrl()`
- Two records are inserted into `stripe_checkout_customer` collection:
  - One for `paymentType: "Card"`
  - One for `paymentType: "Bank Transfer"`
- Each record contains: `checkoutId`, `sessionId`, `customerId`, `checkoutUrl`, `studentId`, `memberId`, `programId`, `yearId`, `utmSource`
- Returns `checkoutId`, `cardUrl`, and `achUrl`

**Key Difference from Semester:** At this stage, `summerSessionId` and `locationId` are **not** included. They are added in Step 2.

**Implementation:** `createNewProgramCheckoutUrls.py` - `createCheckoutSessionUrl()` function

---

### Step 2: Updating Session and Location

**When this happens:** After the user selects a summer session and location, then clicks **Next**.

**API Call:** `POST updateDataToCheckoutUrl` with body: `{checkoutId, summerSessionId, locationId}`

**What happens:**

- The API calls `updateSummerSessionAndLocation(checkoutId, summerSessionId, locationId)`
- Updates **both** `stripe_checkout_customer` records (card and ACH) with:
  - `summerSessionId`
  - `locationId`
- **No new Stripe checkout sessions are created** — only metadata is updated in MongoDB
- The existing Stripe checkout URLs remain valid

**Key Difference from Semester:** Semester checkout updates the Stripe session with class details at this stage. Summer checkout only updates MongoDB metadata; Stripe sessions are updated later when payment is clicked.

**Implementation:** `bcdc_aws-main/payment-checkout-service/api/updateDataToCheckoutUrl.py` - `updateSummerSessionAndLocation()` function

**Frontend:** `bcdc/checkout_summer_bundle.js` - `updateStudentDataInDB()` method

---

### Step 3: Final Update Before Redirecting to Stripe

**When this happens:** When the user clicks either the **ACH** or **Card** payment button.

**API Call:** `POST updateDataToCheckoutUrl` with body: `{checkoutId, isSummerData: true, upsellProgramIds, successUrl, cancelUrl}`

**What happens:**

- The API calls `updateSummerCheckoutUrl()` which:
  - Sets `checkoutClicked: true` in `stripe_checkout_customer`
  - If `upsellProgramIds` are provided, calls `createCheckoutSessionUrlForSummer()` to:
    - Create new Stripe checkout sessions with bundle programs included
    - Update `stripe_checkout_customer` records with new `sessionId` and `checkoutUrl`
    - Include upsell program line items in the Stripe session
- Returns updated `cardUrl` and `achUrl`
- Frontend redirects user to the selected payment URL

**Key Difference from Semester:** Summer checkout creates new Stripe sessions at payment click time (if upsells are selected), whereas semester checkout may update existing sessions.

**Implementation:** `updateDataToCheckoutUrl.py` - `updateSummerCheckoutUrl()` and `createCheckoutSessionUrlForSummer()` functions

**Frontend:** `checkout_summer_bundle.js` - `updateClickEventInDB()` method

---

## After Payment

**Similar to Semester Checkout:** The post-payment flow follows the same webhook-driven pattern as semester checkout, with summer-specific database collections and logic.

## 1. API Triggered After Payment

### `stripePaymentListener` (Stripe Webhook)

**Key Difference from Semester:** Calls `updateSummerPayment()` instead of `updateClassPayment()` for summer program purchases. **\<TODO: Explain how API knows the purchase is summer...?\>**

See [Semester Post-Payment: stripePaymentListener](#) for more detailed implementation.

## `updateSummerPayment()`

 1. Stripe confirms payment → webhook fires
 2. `stripePaymentListener` is invoked
 3. Payment state is normalized (Complete / Processing / Failed)
 4. `updateSummerPayment()` is called with `stripeCheckout`, `status`, `chargeObj`, and `sessionId`
 5. Payment record is inserted or updated in `summer_payment_details`
 6. `stripe_checkout_customer` status is updated
 7. Inventory caps are updated via `updateSummerInventoryCaps()`
 8. Referral & coupon logic runs
 9. Upsell programs are processed (if any)
10. Credit balance is updated (if credits were applied)
11. Emails are triggered
12. User is redirected based on payment type

---

## 3. Database Writes & Updates

### 3.1 `summer_payment_details`

**Insert (first successful payment):**

- `payment_intent` (used as unique identifier for idempotency)
- `submissionId` (same as payment_intent)
- `programId`
- `studentId`
- `memberId`
- `yearId`
- `sessionId` (always `2` for summer)
- `summerSessionId`
- `locationId`
- `paymentTotalChecksum` (amount in dollars)
- `bankToken` (balance_transaction ID)
- `myProducts` (product details)
- `prevStudent`
- `couponCode` (if any)
- `utm_source`
- `createdOn`

**Update (subsequent webhook calls):**

- `status` (Complete / Processing / Failed)
- `receipt_url` (from Stripe charge object)

**Delete (on Failed payment):**

- Existing `summer_payment_details` record is removed via `delete_one()`

**Idempotency:** Uses `payment_intent` to ensure duplicate webhooks don't create multiple records. Checks `find_one({"payment_intent": chargeObj["payment_intent"]})` before insert.

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

---

### 3.2 `stripe_checkout_customer`

**Updated on every webhook event:**

- `payment_intent` (from charge object)
- `status` (`Complete`, `Processing`, `Failed`)

**Lookup:** Uses `sessionId` (Stripe Checkout Session ID) as the unique identifier, not `payment_intent`. All updates use `update_one({'sessionId': sessionId}, ...)`.

**Key Difference from Semester:** Same structure and update pattern as semester checkout.

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

---

### 3.3 Inventory Management (`updateSummerInventoryCaps`)

**Unique to Summer:** Summer programs use `summer_inventory_caps` collection instead of class-based inventory.

**Function:** `updateSummerInventoryCaps(yearId, programId, summerSessionId, locationId, eventType)`

**Logic:**

- **On Failed payment:**
  - Inventory is **released** (`eventType = "add"`)
  - Increments `leftSpot` in `summer_inventory_caps` collection
- **On Complete / Processing:**
  - Inventory is **consumed** (`eventType = "minus"`)
  - Decrements `leftSpot` in `summer_inventory_caps` collection
  - Only triggers for:
    - Card payments with `status == "Complete"`
    - Bank Transfer payments with `status == "Processing"`

**Collection:** `summer_inventory_caps` with fields: `yearId`, `programId`, `summerSessionId`, `locationId`, `numberOfSpots`, `leftSpot`

**Implementation:** `bcdc_aws-main/scheduler_service/api/stripePaymentListener.py` - `updateSummerInventoryCaps()` function

**Reference:** See [Summer MongoDB: summer_inventory_caps](#) for collection structure.

---

### 3.4 Referral & Coupon Handling

**Similar to Semester Checkout:** Follows the same referral and coupon logic as semester checkout.

**If coupon was used:**

- `getCouponCode(sessionId)` retrieves the promotion code from Stripe checkout session
- Searches `referral_details` for matching coupon
- If found, referral is marked as `Purchased` and `purchased_date` is updated
- If not found but coupon exists in `coupon_details`, creates new referral record linking the referrer and purchaser

**If no existing coupon for family:**

- Checks if family has a coupon in `coupon_details` using `familyId`
- If no coupon exists:
  - Generates new coupon code via `generate_coupon_name(firstName)`:
    - Takes member's first name, removes non-alphanumeric, converts to uppercase
    - Generates MD5 hash of name + "100", takes first 5 characters
    - Combines as `BASENAME+5CHARHASH` (e.g., "JOHN12345")
  - Creates coupon in **Stripe** via `generate_coupon_code(coupon_name)`:
    - Minimum purchase: \$100 (10,000 cents)
    - Valid only for first-time transactions
  - Stores coupon in `coupon_details` with:
    - `coupon_code`
    - `familyId`
    - `createdOn`

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

**Reference:** See [Semester Post-Payment: Referral & Coupon Processing](#) for detailed logic.

---

### 3.5 `coupon_details`

**Similar to Semester Checkout:** Same collection and structure.

- New coupon inserted **only once per family** (checked via `familyId`)
- Used for future referrals and discounts
- Coupon code is also created in Stripe for promotion code usage

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

---

### 3.6 Upsell Programs

**Similar to Semester Checkout:** Same upsell processing logic.

If upsell programs were purchased (and payment is Complete/Processing):

- Records inserted via `addUpsellToPaymentDetails(chargeObj, stripeCheckout)`
- Upsell data is stored in `upsell_payment_details` collection
- Links to the main payment via `payment_intent`

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

**Reference:** See [Semester Post-Payment: Enrollment & Cleanup](#) for upsell details.

---

### 3.7 Credit Balance Updates

**Similar to Semester Checkout:** Same credit balance update logic.

If discount / credit was applied (`discount_amount > 0` in `stripeCheckout`):

- `updateCreditBalance(stripeCheckout, chargeObj, yearId, currentSessionId)` is called
- Updates `member_credit_amount` collection
- Reduces `credit_balance` by the applied discount amount
- Linked to:
  - `yearId`
  - `currentSessionId`
  - `memberId`

**Implementation:** `stripePaymentListener.py` - `updateSummerPayment()` function

**Reference:** See [Semester Post-Payment: BDC Credit](#) for credit system details.

---

## 4. Automated Emails

**Similar to Semester Checkout:** Same email triggering logic.

### Admin Emails

- **Sent on:**
  - Card payment → `status == "Complete"`
  - Bank transfer → `status == "Processing"`
- **Triggered via:** `sendSuccessEmailToAdmin(stripeCheckout, yearId)`
- Includes order and enrollment details for admin review

**Implementation:**`stripePaymentListener.py` - `updateSummerPayment()` function

### User Emails

- Stripe receipt generated automatically by Stripe
- `receipt_url` stored in `summer_payment_details` collection
- User receives receipt email directly from Stripe

**Reference:** See [Semester Post-Payment: Emails Triggered](#) for email details.

---

## 5. User Redirection After Payment

**Similar to Semester Checkout:** Same redirection logic based on payment type.

### Card Payments

- Redirected immediately to **Success / Thank You page**
- URL: `payment-confirmation?type=Summer&programName={programName}&transactionID={CHECKOUT_SESSION_ID}`
- Payment status is `Complete` at this point

### Bank Transfer Payments

- Redirected to **Processing / Pending Confirmation page**
- URL: `payment-confirmation?type=Summer&programName={programName}&transactionID={CHECKOUT_SESSION_ID}`
- Payment status is `Processing` initially
- Final confirmation happens asynchronously via webhook when bank transfer completes
- Status updates to `Complete` when webhook receives confirmation

**Reference:** See [Semester Payment: Successful Payment](#) for redirection details.

---

## 6. Failure Handling

**Similar to Semester Checkout:** Same failure handling pattern.

If payment fails (`status == "Failed"`):

- `summer_payment_details` record is **deleted** via `delete_one({"payment_intent": chargeObj["payment_intent"]})`
- Inventory is **restored** via `updateSummerInventoryCaps()` with `eventType = "add"`
- `stripe_checkout_customer` is marked as `Failed`
- No enrollment, coupon generation, or referral processing occurs
- No emails are sent

**Implementation:** ` stripePaymentListener.py` - `updateSummerPayment()` function

**Reference:** See [Semester Post-Payment: Failure Handling](/bdc/checkout-systems/semester/web-checkout/technical/post-payment#c-failure-handling) for failure details.

---